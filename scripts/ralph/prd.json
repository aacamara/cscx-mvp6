{
  "project": "CSCX.AI",
  "branchName": "main",
  "description": "Add organization_id filtering to 6 service files that bypass route-level applyOrgFilter (PRD-007 service layer completion)",
  "userStories": [
    {
      "id": "US-001",
      "title": "Org filter automations service",
      "description": "Add organizationId parameter to all methods in server/src/services/automations/index.ts that query Supabase. There are ~11 queries across tables: automations, automation_runs, customers. For each method that does a Supabase query: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);' after the .from().select(), 3) For INSERT/UPSERT: spread '...(organizationId ? { organization_id: organizationId } : {})' into the data object, 4) For UPDATE/DELETE: add '.eq(\"organization_id\", organizationId)' when organizationId exists. Then update server/src/routes/automations.ts to pass req.organizationId to all service method calls.",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "All INSERT/UPSERT operations include organization_id when provided",
        "Route file passes req.organizationId to all service calls",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Key methods: createAutomation, getAutomation, listAutomations, updateAutomation, deleteAutomation, storeRun, updateRun, getRun, listRuns, getTargetCustomers. Pattern: if (organizationId) query = query.eq('organization_id', organizationId);"
    },
    {
      "id": "US-002",
      "title": "Org filter metrics service",
      "description": "Add organizationId parameter to all methods in server/src/services/metrics.ts that query Supabase. There are ~4 queries across tables: customers, usage_metrics. For each method: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);'. Then update server/src/routes/metrics.ts to pass req.organizationId to all service calls.",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "Route file passes req.organizationId to all service calls",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Key methods: calculateDashboardMetrics, calculateCustomerMetrics. Tables: customers, usage_metrics, qbrs."
    },
    {
      "id": "US-003",
      "title": "Org filter email service",
      "description": "Add organizationId parameter to all methods in server/src/services/email/emailService.ts that query Supabase. There are ~10 queries across tables: emails, email_sync_status, stakeholders, customers. For each method: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);', 3) For UPSERT: spread '...(organizationId ? { organization_id: organizationId } : {})'. Then update server/src/routes/email.ts to pass req.organizationId to all service calls.",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "All UPSERT operations include organization_id when provided",
        "Route file passes req.organizationId to all service calls",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Key methods: fetchAndStoreEmail, updateSyncStatus, getSyncStatus, getEmails, matchByStakeholderEmail, matchByDomain, matchByNameMention, linkEmailsToCustomers, matchAndLinkEmail."
    },
    {
      "id": "US-004",
      "title": "Org filter support service",
      "description": "Add organizationId parameter to all methods in server/src/services/support/index.ts that query Supabase. There are ~6 queries across tables: support_tickets, ticket_baselines, risk_signals. For each method: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);', 3) For INSERT/UPSERT: spread '...(organizationId ? { organization_id: organizationId } : {})'. Then update server/src/routes/support.ts to pass req.organizationId to all service calls.",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "All INSERT/UPSERT operations include organization_id when provided",
        "Route file passes req.organizationId to all service calls",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Key methods: upsertTicket, getTickets, calculateBaseline, getBaseline, handleSpikeDetected."
    },
    {
      "id": "US-005",
      "title": "Org filter feedback service",
      "description": "Add organizationId parameter to all methods in server/src/services/feedback/index.ts that query Supabase. There are ~4+ queries across tables: customers, stakeholders, feedback, feedback_routing_rules. For each method: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);', 3) For INSERT: spread '...(organizationId ? { organization_id: organizationId } : {})'. Then update server/src/routes/feedback.ts to pass req.organizationId to all service calls (including direct Supabase queries in the route file itself).",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "All INSERT operations include organization_id when provided",
        "Route file passes req.organizationId to all service calls",
        "Any direct Supabase queries in the route file also get org filtering",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Key methods: createFeedback, getRoutingRules. Also check route file for direct Supabase queries on feedback_events, feedback_comments, feedback_teams tables."
    },
    {
      "id": "US-006",
      "title": "Org filter NPS service",
      "description": "Add organizationId parameter to all methods in server/src/services/nps/index.ts that query Supabase. There are ~7 queries across tables: nps_responses, customers, risk_signals. For each method: 1) Add 'organizationId: string | null' as last parameter, 2) For SELECT: add 'if (organizationId) query = query.eq(\"organization_id\", organizationId);', 3) For INSERT: spread '...(organizationId ? { organization_id: organizationId } : {})'. Then update server/src/routes/nps.ts to pass req.organizationId to all service calls.",
      "acceptanceCriteria": [
        "All methods with Supabase queries accept organizationId: string | null parameter",
        "All SELECT queries filter by organization_id when organizationId is provided",
        "All INSERT operations include organization_id when provided",
        "Route file passes req.organizationId to all service calls",
        "Typecheck passes (cd server && npx tsc --noEmit)"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Key methods: createNpsResponse, getPreviousResponses, getNpsHistory, initiateRecovery."
    }
  ]
}
