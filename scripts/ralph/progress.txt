## Codebase Patterns
- Express SSE requires res.flushHeaders() before streaming
- WorkflowAgent.chatStream() bypasses LangGraph and calls Anthropic directly
- CADG plans are NOT streamed — sent as single done event
- Codebase has ~161 pre-existing frontend type errors and ~1117 server type errors — focus on not introducing NEW ones
- DEMO_USER_ID = 'df2dc7be-ece0-40b2-a9d7-0f6c45b75131'
- Agent routing: frontend reads data.agentType (specialist name), NOT data.routing.agentType (always 'claude_langgraph')
- CADG document mapping: use switch on finalPlan.taskType, NOT if-else with query substring matching
- Customer context: when customerId provided, always fetch from DB (SupabaseService.getCustomer)
- isGenerativeRequest() should only match explicit generative verbs (create, build, generate, etc.)
- isConversationalQuestion() detects interrogative queries that bypass CADG
- Demo Mode fallback: simulate AI analysis with 2-3s delay and pre-built data when Google OAuth unavailable
- CADGPlanCard handles its own approve API call — not re-submitted as chat message

## Org Filtering Patterns (PRD-007 Phase 4)
- Import from '../middleware/orgFilter.js' (NOT .ts — compiled import)
- applyOrgFilter(query, req) for strict org isolation (returns only org's data or NULL-org demo data)
- applyOrgFilterInclusive(query, req) for shared+org data (KB articles, templates)
- withOrgId(data, req) wraps INSERT/UPSERT data with organization_id
- Pattern for SELECT: `let query = supabase.from('table').select('*'); query = applyOrgFilter(query, req);`
- Pattern for INSERT: `await supabase.from('table').insert(withOrgId({ ...data }, req))`
- For UPDATE/DELETE by ID, add org scoping: `.eq('id', id)` — no extra org filter needed since IDs are globally unique
- See server/src/routes/customers.ts and dashboard.ts for working examples
- req.organizationId comes from auth middleware (resolveOrgMembership)
- When no org context (demo mode), applyOrgFilter uses .is('organization_id', null)

## Service Layer Org Filtering (PRD-007 Phase 5)
- For service methods: add `organizationId: string | null = null` as last parameter
- SELECT pattern in services: `if (organizationId) query = query.eq('organization_id', organizationId);`
- INSERT pattern in services: `...(organizationId ? { organization_id: organizationId } : {})`
- Route callers pass `req.organizationId` to all service method calls
- For methods that call other methods, thread organizationId through entire call chain
- Some route files have direct Supabase queries bypassing service layer — check for `.from()` in routes too

## Auth Flow Patterns
- needsOrgSetup detection requires hasCheckedOrg companion flag (AuthContext)
- hasCheckedOrg distinguishes "still loading org membership" from "checked and no org found"
- Auth state machine: loading → checked-no-org → has-org → fully-authenticated
- Login.tsx has two paths: invite code flow and create-org flow (Google OAuth)

---

# QA Bug Fixes Progress Log

Branch: ralph/qa-bug-fixes
Started: 2026-02-15

---

## 2026-02-15 - US-001
- **What:** Fixed recursive requireAuth bug in agentic-agents.ts
- **Files:** server/src/routes/agentic-agents.ts
- **Fix:** Changed line 106 from `requireAuth(req, res)` to `getUserId(req)`, removed duplicate guard
- **Commit:** 4dacb3e

---

## 2026-02-15 - US-002
- **What:** Fixed agent routing to respect manual specialist selection
- **Files:** components/AgentControlCenter/index.tsx
- **Fix:** Frontend was reading `data.routing.agentType` (always 'claude_langgraph') instead of `data.agentType` (actual specialist). Fixed in both streaming and non-streaming handlers.
- **Commit:** e20a677
- **Learning:** Backend was correct all along — the bug was frontend-only, reading the wrong field

---

## 2026-02-15 - US-003
- **What:** Fixed CADG document type mapping — stop defaulting to Stakeholder Map
- **Files:** server/src/routes/cadg.ts, server/src/services/cadg/artifactGenerator.ts
- **Fix:** Replaced ~1300-line if-else chain (that matched on taskType AND query substrings causing collisions) with clean switch on finalPlan.taskType. Added all 24 card type titles to formatTaskTitle().
- **Commit:** c46352b
- **Learning:** The task classifier was fine — the bug was in the approval route's dispatch logic

---

## 2026-02-15 - US-004
- **What:** Fixed customer context injection in Demo Mode
- **Files:** server/src/routes/langchain.ts
- **Fix:** When customerContext not provided but customerId IS provided, fetch real customer data from DB via SupabaseService.getCustomer(). Applied to all 3 chat endpoints (/chat/stream, /chat, /chat/:agentType).
- **Commit:** d308fa9

---

## 2026-02-15 - US-005
- **What:** Populated all customers in Agent Center dropdown
- **Files:** components/AgentCenterView.tsx
- **Fix:** Added limit=100 to /api/customers fetch. Replaced native <select> with custom searchable dropdown for 33+ items.
- **Commit:** 46665c9

---

## 2026-02-15 - US-006
- **What:** Fixed conversational response mode in Demo Mode
- **Files:** server/src/services/cadg/taskClassifier.ts, server/src/services/cadg/index.ts
- **Fix:** Tightened isGenerativeRequest() to only match explicit generative verbs (removed "help me", "show me", "analyze"). Added isConversationalQuestion() to detect interrogative queries that bypass CADG.
- **Commit:** 5a136dc

---

## 2026-02-15 - US-007
- **What:** Fixed Generate/Approve button in Demo Mode
- **Files:** components/AIPanel/CADGPlanCard.tsx
- **Fix:** Approve button now calls POST /api/cadg/plan/:planId/approve instead of re-submitting as chat message. Added loading state and disabled button after click.
- **Commit:** 7994885

---

## 2026-02-15 - US-008
- **What:** Fixed Onboarding Wizard hang at Analysis step in Demo Mode
- **Files:** components/AgentStudio/OnboardingFlow.tsx, components/UnifiedOnboarding.tsx
- **Fix:** Added Demo Mode detection — when Google OAuth unavailable, simulate contract analysis with 2-3s delay and pre-built mock data (customer info, stakeholders, entitlements, recommendations).
- **Commit:** 6f8f2e9

---

## 2026-02-15 - US-009
- **What:** Fixed CSV export with Demo Mode fallback
- **Files:** components/AIPanel/CADGPlanCard.tsx
- **Fix:** Added local CSV generation from plan structure data when Google Docs export fails. Generates columns: Step, Description, Status, Assignee.
- **Commit:** b3bf8eb

---

## 2026-02-15 - US-010
- **What:** Integration verification — end-to-end retest
- **Verification:**
  - All 9 story commits landed on ralph/qa-bug-fixes branch
  - TypeScript: 161 frontend errors (all pre-existing), 0 new errors
  - 11 files changed, 808 insertions, 1099 deletions (net cleanup)
  - Server compiles clean (all errors pre-existing)
  - All 24 CADG card types have explicit dispatch paths
  - Agent routing reads correct field (data.agentType)
  - Customer context fetches from DB when customerId provided
  - Conversational queries bypass CADG
  - Demo Mode: onboarding wizard, CSV export, approve button all have fallbacks

---

## 2026-02-16 - US-007 (PRD-007 Phase 4)
- **What:** Added org filtering to admin.ts and onboarding.ts
- **Files changed:**
  - server/src/routes/admin.ts — imported applyOrgFilter, wrapped 3 `.from('customers')` SELECT queries (totalCustomers, atRisk, healthy) with applyOrgFilter
  - server/src/routes/onboarding.ts — imported applyOrgFilter + withOrgId, wrapped `.from('customers')` SELECT (existence check + GET workspace), `.from('customers')` INSERT with withOrgId, `.from('plan_tasks')` SELECT with applyOrgFilter, `.from('plan_tasks')` UPSERT/INSERT with withOrgId, `.from('plan_tasks')` UPDATE with applyOrgFilter
  - scripts/ralph/prd.json — set US-007 passes to true
- **Learnings for future iterations:**
  - admin.ts only has SELECT queries on customers (count queries) — no INSERTs, so only applyOrgFilter needed
  - onboarding.ts has both SELECT and INSERT on customers AND plan_tasks — needs both applyOrgFilter and withOrgId
  - For chained queries like `.update(updates).eq('customer_id', x).eq('phase_index', y)`, insert applyOrgFilter before the `.eq()` chains

---

## 2026-02-16 - US-011 (PRD-007 Phase 4)
- **What:** Added org filtering to final batch of 10 route files
- **Files changed:**
  - server/src/routes/workspace-agent.ts — imported applyOrgFilter, threaded `req` through executeHealthScoreAction (customers, health_score_history), executeRenewalAction (customers), executeKnowledgeAction (customers), executeMeetingIntelligenceAction (meeting_analyses x3)
  - server/src/routes/thank-you.ts — wrapped customers queries in preview, send, and occasions endpoints; wrapped thank_you_log query in history endpoint
  - server/src/routes/pattern-recognition.ts — wrapped customers queries in /portfolio and /alerts endpoints
  - server/src/routes/executive-changes.ts — wrapped customers query in /research endpoint; wrapped executive_change_tasks query in /tasks endpoint
  - server/src/routes/onboarding-progress.ts — wrapped customer_onboarding_progress query in main GET; wrapped customers and customer_onboarding_progress queries in /:customerId detail endpoint
  - server/src/routes/qbr-email.ts — wrapped customers, stakeholders, usage_metrics queries in both preview (GET) and send (POST) endpoints
  - server/src/routes/agentAnalysis.ts — added req param to fetchCustomerData and fetchUsageMetrics helper functions; applied applyOrgFilter inside them
  - server/src/routes/metrics.ts — wrapped customers UPDATE query in health-score PUT; wrapped qbrs SELECT in QBR history GET
  - server/src/routes/automations.ts — wrapped customers segment query in /parse; wrapped automations and automation_runs queries in /stats
  - server/src/routes/email-suggestions.ts — wrapped stakeholders query in /suggest-response; added organization_id to tasks INSERT
  - scripts/ralph/prd.json — set US-011 passes to true
- **Learnings for future iterations:**
  - workspace-agent.ts has helper functions (executeHealthScoreAction, etc.) that don't receive `req` — must thread `req` as a new param through the call chain
  - agentAnalysis.ts similarly has helper functions (fetchCustomerData, fetchUsageMetrics) — made `req` optional param to maintain backwards compatibility
  - For INSERT statements that don't use withOrgId() helper, add organization_id directly from req.organizationId
  - Some files use `let supabase` (nullable) while others use `const supabase = createClient(...)` (non-null) — same pattern works for both

---

## 2026-02-19 - US-002 (PRD-007 Service Layer)
- **What:** Added organizationId filtering to metrics service layer
- **Files changed:**
  - server/src/services/metrics.ts — Added organizationId: string | null parameter to calculateDashboardMetrics() and calculateCustomerMetrics(); applied org filtering to customers and usage_metrics queries
  - server/src/routes/metrics.ts — Updated /dashboard and /customer/:customerId endpoints to pass req.organizationId to service calls
  - scripts/ralph/prd.json — set US-002 passes to true
- **Learnings for future iterations:**
  - metrics.ts only has 2 async methods that query Supabase: calculateDashboardMetrics (queries customers + usage_metrics) and calculateCustomerMetrics (queries customers + usage_metrics)
  - All other exports in metrics.ts are pure calculation functions that don't touch the database
  - For queries that were already stored in variables (like `let customersQuery`), maintain that pattern and add org filter conditionally
  - For queries that were one-liners (like `.from('usage_metrics').select()...`), refactor to `let query = ...` then add conditional org filter
  - TypeScript allows optional parameters with `string | null` — makes org filtering backwards compatible

---

## 2026-02-19 - US-006 (PRD-007 Service Layer)
- **What:** Added organizationId filtering to NPS service layer
- **Files changed:**
  - server/src/services/nps/index.ts — Added organizationId: string | null parameter to createNpsResponse(), getPreviousResponses(), getNpsHistory(), initiateRecovery(), updateRecoveryStatus(); applied org filtering to nps_responses, customers, risk_signals, and plan_tasks queries; spread organization_id into INSERT operations
  - server/src/routes/nps.ts — Updated all 7 service method calls (POST /responses, GET /customers/:customerId/nps, POST /responses/:responseId/initiate-recovery, PATCH /responses/:responseId/recovery, POST /webhooks/delighted, POST /webhooks/typeform) to pass req.organizationId
  - scripts/ralph/prd.json — set US-006 passes to true
- **Learnings for future iterations:**
  - NPS service has 5 methods with Supabase queries: createNpsResponse (INSERT nps_responses + INSERT risk_signals + INSERT plan_tasks), getPreviousResponses (SELECT nps_responses), getNpsHistory (SELECT nps_responses), initiateRecovery (SELECT + UPDATE nps_responses, SELECT customers, INSERT risk_signals, INSERT plan_tasks), updateRecoveryStatus (UPDATE nps_responses)
  - For methods like initiateRecovery that have multiple query types (SELECT, UPDATE, INSERT), apply org filtering to each individually
  - For UPDATE queries with org filtering, refactor from one-liner to `let query = ...update().eq('id', id); if (organizationId) query = query.eq('organization_id', organizationId);`
  - The route file has 7 service call sites including 2 webhook endpoints — don't forget the webhook routes
  - No type errors introduced — verified with `npx tsc --noEmit 2>&1 | grep -E "(services/nps|routes/nps)"`

---

## 2026-02-19 - US-001 (PRD-007 Service Layer)
- **What:** Added organizationId filtering to automations service layer
- **Files changed:**
  - server/src/services/automations/index.ts — Added organizationId: string | null parameter to 11 methods: createFromNL(), createAutomation(), getAutomation(), listAutomations(), updateAutomation(), deleteAutomation(), runAutomation(), storeRun(), updateRun(), getRun(), listRuns(), getTargetCustomers(); applied org filtering to automations, automation_runs, and customers queries; spread organization_id into INSERT operations
  - server/src/routes/automations.ts — Updated all 13 service method calls (POST /from-nl, GET /, GET /:id, POST /, PUT /:id, DELETE /:id, POST /enable, POST /disable, POST /run, GET /runs, GET /runs/:id) to pass req.organizationId
  - scripts/ralph/prd.json — set US-001 passes to true
- **Learnings for future iterations:**
  - Automations service has 11 methods with Supabase queries across 3 tables (automations, automation_runs, customers)
  - For complex methods like runAutomation() that call other private methods, organizationId must be threaded through the entire call chain (runAutomation → storeRun, updateRun, getTargetCustomers)
  - For getTargetCustomers(), each branch (specific_customers, customer_segment, all_customers) needs org filtering on customers table
  - For UPDATE queries with org filtering, use pattern: `let query = ...update().eq('id', id); if (organizationId) query = query.eq('organization_id', organizationId);`
  - No type errors introduced — verified with `npx tsc --noEmit 2>&1 | grep -E "(services/automations|routes/automations)"`

---

## 2026-02-20 - US-004 (PRD-007 Service Layer)
- **What:** Verified and completed organizationId filtering in support service layer
- **Files changed:**
  - server/src/services/support/index.ts — Already had organizationId: string | null parameter added to all 10+ methods (processTicketWebhook, upsertTicket, getTickets, calculateBaseline, getBaseline, detectTicketSpike, handleSpikeDetected, createRiskSignal, getRiskSignals, acknowledgeSignal, resolveSignal, getSupportSummary) in earlier commit bccee5d
  - server/src/routes/support.ts — Updated all service method calls to pass (req as any).organizationId consistently
  - scripts/ralph/prd.json — set US-004 passes to true
- **Learnings for future iterations:**
  - Support service changes were already completed in commit bccee5d (US-006) — work was done out of order
  - Routes file needed verification to ensure all service calls pass organizationId consistently
  - Pre-existing TS errors (~1117 server errors) are unrelated to org filtering work
  - Service methods default organizationId to null for backward compatibility
  - Tables affected: support_tickets, ticket_baselines, risk_signals
  - For complex workflows like processTicketWebhook → upsertTicket → detectTicketSpike → handleSpikeDetected, organizationId must be threaded through the entire chain
  - All SELECT queries use `if (organizationId) query = query.eq('organization_id', organizationId);`
  - All INSERT/UPSERT queries use `...(organizationId ? { organization_id: organizationId } : {})`
- **Commit:** 7e210f6

---

## 2026-02-20 - US-003 (PRD-007 Service Layer)
- **What:** Added organizationId filtering to email service layer
- **Files changed:**
  - server/src/services/email/emailService.ts — Added organizationId parameter to fetchAndStoreEmail(), updateSyncStatus(), getSyncStatus(), getEmails(), matchByStakeholderEmail(), matchByDomain(), matchByNameMention(), linkEmailsToCustomers(), matchAndLinkEmail()
  - server/src/routes/email.ts — Updated all service method calls to pass req.organizationId
- **Learnings:**
  - Email service has ~10 methods across 4 tables (emails, email_sync_status, stakeholders, customers)
  - matchAndLinkEmail() orchestrates sub-methods — organizationId threaded through entire chain
- **Commit:** ec60e18

---

## 2026-02-20 - US-005 (PRD-007 Service Layer)
- **What:** Added organizationId filtering to feedback service layer
- **Files changed:**
  - server/src/services/feedback/index.ts — Added organizationId parameter to createFeedback(), getRoutingRules()
  - server/src/routes/feedback.ts — Updated service calls + direct Supabase queries on feedback_events, feedback_comments, feedback_teams
- **Learnings:**
  - Feedback route file has DIRECT Supabase queries bypassing service layer — these also need org filtering
  - Always check route files for direct .from() calls
- **Commit:** a4bc9d1

---

## 2026-02-20 - Auth Flow Fix (Production Readiness)
- **What:** Fixed critical needsOrgSetup bug — new users couldn't reach SignupPage after Google OAuth
- **Files changed:**
  - context/AuthContext.tsx — Added hasCheckedOrg flag to distinguish "still loading" from "no org found"
  - App.tsx — Added useEffect to detect "authenticated but no org" → sets needsOrgSetup=true
  - components/Login.tsx — Added "Create Organization" guidance with Google sign-in for users without invite codes
- **Learnings:**
  - Boolean states starting as false that depend on async data need a "has checked" companion flag
  - Auth state machines: loading → checked-no-org → has-org → fully-authenticated
- **Part of:** multi-tenant merge commit 4260cb8

---

## 2026-02-21 - PRD-023: Customer Self-Service Production Readiness (ALL COMPLETE)

### Route-Level Org Filtering (Batch 2-4)
- **chat.ts**: 7 endpoints protected (messages CRUD, sessions, history)
- **workspace.ts**: 1 endpoint protected (stakeholder contacts)
- **timeline.ts**: 8 endpoints protected (events, stats, milestones, health, heatmap)
- **stakeholders.ts**: 14 locations protected (stakeholders, risk_signals, departure_tasks)
- **contracts.ts**: INSERT operations protected with withOrgId
- **cadg.ts**: 26 agent_activity inserts wrapped with withOrgId

### Service Layer Org Filtering
- **SupabaseService** (supabase.ts): getContract(), listContracts(), saveContract() — all accept organizationId
- **accountPlanGenerator** (account-plan-generator.ts): gatherPlanningContext (5 queries), savePlan, getPlan, updatePlanStatus, updatePlan — all org-filtered
- **CADG contextAggregator** (contextAggregator.ts): aggregateContext, gatherPlatformData, gatherExternalSources, fetchPreviousArtifacts — all org-filtered
- **CADG artifactGenerator** (artifactGenerator.ts): generate, saveArtifact, getArtifact — all org-filtered

### Schema Fixes
- Fixed table name mismatch: 27x `agent_activities` → `agent_activity_log` (cadg.ts + contextAggregator.ts)
- Created migration 100: organization_id on execution_plans, generated_artifacts, agent_activity_log

### PRD-023 Tasks Completed
- **US-001 (PASS)**: Google OAuth config verified production-ready
- **US-002 (PASS + FIX)**: Fixed SignupPage.tsx org ID extraction bug (data.organization?.id)
- **US-004 (PASS + FIX)**: Added .docx/.doc to ContractUpload.tsx accept list; contract reads now org-filtered
- **US-006 (DONE)**: CSM-scoped customer filtering — CSMs see only assigned customers via csm_id
- **US-008 (DONE)**: Full CADG service layer org filtering + table name fix + migration
- **US-010 (DONE)**: Playwright smoke test at scripts/verify-core-flows.ts — 7 flows + 3 bonus checks

### Files Changed (21 files)
- server/src/routes/cadg.ts, chat.ts, workspace.ts, timeline.ts, stakeholders.ts, contracts.ts, account-plans.ts, agents.ts, customers.ts
- server/src/services/supabase.ts, ai/account-plan-generator.ts
- server/src/services/cadg/contextAggregator.ts, artifactGenerator.ts
- components/Auth/SignupPage.tsx, ContractUpload.tsx
- database/migrations/100_add_org_id_cadg_tables.sql
- scripts/verify-core-flows.ts
- scripts/ralph/prd-023-self-service.json

### Learnings:
- CADG code referenced `agent_activities` but the actual DB table is `agent_activity_log` (migration 008) — inserts were silently failing
- Migration 074 used wrong table names (cadg_execution_plans vs execution_plans) — always verify actual table names in migrations
- SignupPage was reading `data.organizationId` but the API returns `data.organization.id` — response shape must match client expectations
- ContractUpload.tsx accept attribute must include all file types the server supports

---
