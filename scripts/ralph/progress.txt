# Ralph Progress Log
Started: Thu 29 Jan 2026 00:03:28 EST
---

## Codebase Patterns
- Migrations are in `database/migrations/` with sequential numbering (001, 002, etc.)
- Use `IF NOT EXISTS` and `IF EXISTS` for idempotent migrations
- RLS policies follow pattern: `{table}_{role}_{action}_policy` (e.g., `chat_messages_user_select_policy`)
- For FK to Supabase auth users, reference `auth.users(id)` not `public.users(id)`
- Use DO $$ blocks for dynamic SQL in migrations (e.g., finding and dropping constraints)
- Pre-existing TypeScript errors exist in server/ - don't let these block unrelated work

---

## Wed 29 Jan 2026 - US-002
- **What was implemented:** Updated /chat-message endpoint with proper error handling and documentation
- **Files changed:**
  - `server/src/routes/agentActivities.ts` (modified)
- **Details:**
  - Added JSDoc documentation explaining the schema (user_id stores auth.uid() directly, no FK)
  - Made customer_id explicitly optional (null for general mode chat)
  - Added descriptive error messages for all error cases (401, 400, 503, 500)
  - Added role validation (must be 'user', 'assistant', or 'system')
  - Added explicit null handling for optional fields (customer_id, agent_type, tool_calls, session_id)
  - Separated database errors from internal server errors for better debugging
- **Learnings for future iterations:**
  - Error responses should include both `error` (short code) and `message` (descriptive explanation)
  - Document schema assumptions in JSDoc comments, especially when they differ from typical patterns
  - agentActivities.ts has no TypeScript errors despite server-wide build failures
---

## Wed 29 Jan 2026 - US-001
- **What was implemented:** Migration to fix chat_messages user_id FK constraint
- **Files changed:**
  - `database/migrations/021_fix_chat_messages_userid.sql` (new)
- **Details:**
  - Drop FK constraint on user_id that referenced public.users(id)
  - user_id now stores auth.uid() directly without FK
  - Enabled RLS on chat_messages table
  - Added user policies (select, insert, update, delete) checking user_id = auth.uid()
  - Added admin policies for full access
  - Migration is idempotent (uses IF EXISTS/IF NOT EXISTS, DO blocks)
- **Learnings for future iterations:**
  - The original 012_chat_messages_table.sql referenced public.users which exists (002_google_workspace.sql creates it), but the app was using auth.uid() directly without ensuring records in public.users
  - RLS policies in this codebase use auth.jwt() -> 'user_metadata' ->> 'role' for admin checks
  - Always check existing migration patterns (020_enable_rls.sql has good examples)
---
