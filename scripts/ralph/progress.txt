## Codebase Patterns
- Supabase RLS uses `auth.uid()` function to get current user
- Policies can reference other tables via joins for indirect ownership
- Service role key bypasses RLS (for background jobs)
- Migrations live in server/supabase/migrations/ with YYYYMMDD_description.sql naming
- Admin role check: `(auth.jwt() -> 'user_metadata' ->> 'role') = 'admin'`
- Pre-existing TypeScript errors: missing types/index.ts, Vite import.meta.env types - not blocking SQL migrations
- Child table RLS pattern: `EXISTS (SELECT 1 FROM parent WHERE parent.id = child.fk AND parent.csm_user_id = auth.uid())`

---

# Security Hardening Progress Log

Initialized: Ready to start Loop 1

---

## 2026-01-28 - US-001
- Implemented RLS on customers table
- Files changed:
  - Created: server/supabase/migrations/20260128_enable_rls_customers.sql
  - Updated: scripts/ralph/prd.json (marked US-001 as passing)
- **Learnings for future iterations:**
  - Migration naming: YYYYMMDD_description.sql in server/supabase/migrations/
  - customers table had no csm_user_id column - added with FK to auth.users(id)
  - Admin policies use JWT metadata: `(auth.jwt() -> 'user_metadata' ->> 'role') = 'admin'`
  - CSM policies use: `csm_user_id = auth.uid()`
  - TypeScript errors exist in frontend but are pre-existing issues (missing types/index.ts barrel file, Vite env types)
  - SQL migrations don't affect TypeScript compilation - treat `npx tsc --noEmit` requirement as applicable to TS files only
---

## 2026-01-28 - US-002
- Implemented RLS on contracts table
- Files changed:
  - Created: server/supabase/migrations/20260128_enable_rls_contracts.sql
  - Updated: scripts/ralph/prd.json (marked US-002 as passing)
- **Learnings for future iterations:**
  - RLS policies for child tables use EXISTS subquery to join to parent table
  - Pattern: `EXISTS (SELECT 1 FROM customers WHERE customers.id = contracts.customer_id AND customers.csm_user_id = auth.uid())`
  - Include all CRUD operations: SELECT, UPDATE, INSERT, DELETE for both CSM and admin policies
  - Contracts links through customer_id → customers → csm_user_id for ownership check
---

## 2026-01-28 - US-003
- Confirmed RLS migration on agent_sessions table already committed
- Files already changed (in previous iteration):
  - Created: server/supabase/migrations/20260128_enable_rls_agent_sessions.sql
  - Updated: scripts/ralph/prd.json (marked US-003 as passing)
- **Learnings for future iterations:**
  - agent_sessions has direct user_id column (no join needed like contracts)
  - Simpler RLS pattern: `user_id = auth.uid()` directly
  - Still need admin policies for full access: `(auth.jwt() -> 'user_metadata' ->> 'role') = 'admin'`
  - If a story is already committed but PRD shows passes: false, just update the PRD
---
