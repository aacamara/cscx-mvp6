## Codebase Patterns
- Express SSE requires res.flushHeaders() before streaming
- Use res.write() not res.send() for streaming
- Set Cache-Control: no-cache header
- AbortController handles client disconnects
- Gemini uses generateContentStream() for streaming
- Anthropic uses stream: true option with messages.create()
- Claude streaming events: message_start, content_block_start, content_block_delta, content_block_stop, message_delta, message_stop
- Thinking blocks in Claude have type 'thinking' in content_block_start event
- Token counts from Claude: input_tokens from message_start.message.usage, output_tokens from message_delta.usage

- Agent routes are in server/src/routes/agents.ts
- StreamEvent type is exported for reuse by frontend components
- Pre-existing TypeScript errors in codebase (not related to streaming implementation)
- ClaudeService in server/src/services/claude.ts, GeminiService in server/src/services/gemini.ts
- BaseAgent.thinkStream() in server/src/agents/base.ts handles model-specific streaming

---

# Streaming Chat Progress Log

Initialized: Ready to start Loop 2

---

## 2026-01-28 - US-001
- Implemented POST /api/agents/chat/stream SSE endpoint
- Files changed: server/src/routes/agents.ts (+229 lines)
- **Learnings for future iterations:**
  - res.flushHeaders() must be called after setting headers to start SSE
  - Use req.on('close') and req.on('aborted') to detect client disconnects
  - sendSSEEvent helper sends `data: ${JSON.stringify(event)}\n\n` format
  - X-Accel-Buffering: no header disables nginx buffering for SSE
  - StreamEvent type is exported for use by frontend (US-005)
  - Pre-existing TypeScript errors exist in codebase (100+ errors) - focus on not introducing new errors
---

## 2026-01-28 - US-003
- Implemented Claude streaming responses
- Files changed:
  - server/src/services/claude.ts (+124 lines) - added generateStream method
  - server/src/agents/base.ts (+9 lines, -15 lines) - updated thinkStream to use Claude streaming
- **Learnings for future iterations:**
  - Anthropic streaming uses `stream: true` in messages.create() options
  - Stream events are: message_start, content_block_start, content_block_delta, content_block_stop, message_delta, message_stop
  - Thinking blocks (extended thinking) have type 'thinking' in content_block_start.content_block.type
  - Text deltas are in content_block_delta events with delta.type === 'text_delta'
  - Input tokens available in message_start.message.usage.input_tokens
  - Output tokens available in message_delta.usage.output_tokens
  - ThinkingCallback type exported from base.ts for thinking block notifications
  - ClaudeService falls back to Gemini streaming if Claude streaming fails
---
