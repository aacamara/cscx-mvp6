{
  "project": "CSCX.AI",
  "branchName": "ralph/qa-bug-fixes",
  "description": "Fix 6 QA-identified bugs from CSM agent testing — agent routing, CADG document mapping, customer context injection, demo mode completeness, conversational responses, and generate button",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix recursive requireAuth bug in agentic-agents.ts",
      "description": "As a developer, I need to fix a critical infinite recursion bug in the auth helper.",
      "acceptanceCriteria": [
        "Fix requireAuth function at line 105-116 in server/src/routes/agentic-agents.ts — it calls itself recursively (line 106: const userId = requireAuth(req, res)) instead of calling getUserId(req)",
        "Change line 106 from 'const userId = requireAuth(req, res)' to 'const userId = getUserId(req)'",
        "Remove duplicate 'if (!userId) return;' on line 107 (line 108 handles it)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Critical bug at server/src/routes/agentic-agents.ts lines 105-116. The function requireAuth() calls itself on line 106 instead of calling getUserId(). This causes infinite recursion for any authenticated endpoint. Fix: change line 106 to 'const userId = getUserId(req);' and remove the duplicate guard on line 107."
    },
    {
      "id": "US-002",
      "title": "Fix agent routing to respect manual specialist selection",
      "description": "As a CSM, when I manually select a specialist agent (Risk, Adoption, etc.), the system should use that agent, not default to Strategic.",
      "acceptanceCriteria": [
        "Verify frontend AgentControlCenter sends forceAgent correctly when user selects a specialist (components/AgentControlCenter/index.tsx around line 969-970)",
        "Verify backend langchain.ts chat/stream endpoint at line 466 receives forceAgent from request body",
        "Verify the forceAgent value is passed through to WorkflowAgent — check that customerContext._specialistPersona is set based on forceAgent, not ignored",
        "If forceAgent is set, the specialist persona matching that agent MUST be loaded into the system prompt (WorkflowAgent.ts line 2232-2266)",
        "The response label must show the correct agent name (e.g., 'Risk Specialist' not 'Strategic CSM')",
        "Test: selecting Risk agent and asking about churn should route to Risk, not Strategic",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Trace the full path: AgentControlCenter (line 969: forceAgent: selectedAgent !== 'auto' ? selectedAgent : undefined) → POST /api/ai/chat/stream (langchain.ts:466) → WorkflowAgent.chatStream(). The forceAgent parameter must propagate to the specialist persona selection in WorkflowAgent.ts at lines 2232-2266 where it reads customerContext._specialistPersona. Check if _specialistPersona is being set from forceAgent in langchain.ts before passing to WorkflowAgent. Also check orchestrator.ts:298-316 orchestrator.chatWithSpecialist() which should be called when forceAgent is provided."
    },
    {
      "id": "US-003",
      "title": "Fix CADG document type mapping — stop defaulting to Stakeholder Map",
      "description": "As a CSM, when I request a kickoff plan, I should get a kickoff plan document, not a Stakeholder Map.",
      "acceptanceCriteria": [
        "Investigate server/src/services/cadg/taskClassifier.ts — verify all 24 card types have correct phrase patterns and keywords",
        "Investigate server/src/routes/cadg.ts plan approval endpoint — verify taskType from classification is passed through to artifact generation",
        "Check server/src/services/cadg/artifactGenerator.ts — verify it has generation templates for each of the 24 task types (not just stakeholder_map)",
        "If some document types fall back to stakeholder_map due to missing templates, add proper templates or at minimum generate distinct content per type",
        "Test: 'Create a kickoff plan' should produce kickoff plan content, not stakeholder map",
        "Test: 'Build a training schedule' should produce training schedule, not stakeholder map",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "The taskClassifier.ts at lines 142-425 has all 24 card types defined. The issue is likely in artifactGenerator.ts which may only implement stakeholder_map template and fall through to it for unimplemented types. Check the generate*Preview() methods in artifactGenerator.ts. Each task type needs its own generation path. Also check cadg.ts POST /api/cadg/plan/:planId/approve — verify taskType is preserved from plan creation through to artifact generation."
    },
    {
      "id": "US-004",
      "title": "Fix customer context injection in Demo Mode — remove ACME placeholder",
      "description": "As a CSM in Demo Mode, generated content should use the selected customer's real data, not 'ACME Corporation'.",
      "acceptanceCriteria": [
        "In langchain.ts chat/stream handler (line 478-488), when customerContext is not provided in the request body, fetch customer data from database using customerId instead of using placeholder defaults",
        "If customerId is provided, call db.getCustomer(customerId) and build real context (similar to how agentic-agents.ts buildContext works at lines 119-162)",
        "Ensure the customer name, ARR, health score, renewal date, and contacts are injected into the context passed to WorkflowAgent",
        "Remove or guard the fallback 'Unknown Customer' defaults — only use them if no customer is selected AND no customerId provided",
        "Verify WorkflowAgent.ts at line 2236-2273 injects the context into Claude's system prompt correctly",
        "Test in Demo Mode: select TechStart Inc, ask a question — response should reference TechStart, not ACME",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "The root issue is in langchain.ts lines 478-488 where context is built. When customerContext is not passed from frontend (which may happen in Demo Mode), it falls back to {name: 'Unknown Customer', ...}. Fix: if customerId is in the request, fetch the real customer data from the database before building context. Reference how agentic-agents.ts does it at lines 119-162 with buildContext(). The frontend AgentControlCenter does send customerId when a customer is selected — it's the backend that doesn't fetch data from it."
    },
    {
      "id": "US-005",
      "title": "Populate all customers in Agent Center dropdown for Demo Mode",
      "description": "As a CSM in Demo Mode, I should see all 33 customers in the Agent Center dropdown, not just 3.",
      "acceptanceCriteria": [
        "Find the customer selector component in components/AgentControlCenter/ (search for customer dropdown/select/picker)",
        "Verify the API call to /api/customers fetches all customers, not a limited set",
        "If there is a filter limiting to 3 customers in Demo Mode, remove it or expand it",
        "All 33 demo customers from the database should appear in the dropdown",
        "Add search/filter to the dropdown since 33 items is a longer list",
        "Test: Demo Mode Agent Center dropdown shows all 33 customers",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "The Dashboard shows all 33 customers but Agent Center only shows 3. The customer selector in AgentControlCenter may have a hardcoded list or a different API endpoint. Check if it fetches from /api/customers with any limiting params. The customers route is at server/src/routes/customers.ts. Compare how Dashboard fetches customers vs how Agent Center does it."
    },
    {
      "id": "US-006",
      "title": "Fix conversational response mode in Demo Mode",
      "description": "As a CSM in Demo Mode, simple questions should get conversational answers, not always Execution Plans.",
      "acceptanceCriteria": [
        "In langchain.ts chat/stream handler, before CADG classification, add intent detection: if the query is a simple question (starts with 'what', 'how', 'why', 'when', 'which', 'should', 'can'), route to conversational mode",
        "Conversational mode should call WorkflowAgent.chatStream() directly WITHOUT going through CADG classification",
        "CADG classification (execution plans) should only trigger for generative intents: 'create', 'build', 'generate', 'design', 'prepare', 'draft', 'make'",
        "The CADG classifier confidence threshold of 0.7 (line 505) should be respected — below 0.7 means conversational",
        "Test in Demo Mode: 'What should I focus on this week?' → conversational text answer, not Execution Plan",
        "Test in Demo Mode: 'Create a kickoff plan for HealthFirst' → Execution Plan (correct)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "In authenticated mode, conversational responses work because the WorkflowAgent handles the query directly when CADG classification confidence is below 0.7. In Demo Mode, the issue might be that CADG always returns high confidence. Check taskClassifier.ts — the classify() method may be too aggressive with matching. Also check if Demo Mode sends different parameters that affect classification. The fix should ensure that non-generative queries (questions, advice-seeking) bypass CADG and go straight to WorkflowAgent for a conversational response."
    },
    {
      "id": "US-007",
      "title": "Fix Generate/Approve button to execute plan instead of re-submitting prompt",
      "description": "As a CSM in Demo Mode, clicking 'Approve & Generate' on an Execution Plan should execute it, not create a duplicate plan.",
      "acceptanceCriteria": [
        "Find the Execution Plan card component in frontend (search for 'Approve', 'Generate Template', 'CADGPlanCard')",
        "Verify the approve button click handler calls POST /api/cadg/plan/:planId/approve (not re-submitting as a new chat message)",
        "The planId must be passed from the CADG plan card to the approve endpoint",
        "After approval, the backend should call artifactGenerator to generate the document preview",
        "The response should show the generated artifact (document preview, Save Play card, etc.), not another Execution Plan",
        "Disable the button after first click to prevent duplicate submissions",
        "Add loading state: show 'Generating...' spinner while artifact is being created",
        "Test in Demo Mode: approve an Execution Plan → see generated output, not a duplicate plan",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "In authenticated mode, this works — the Save Play card generates correctly. The issue in Demo Mode is likely that the approve button's click handler sends a new chat message instead of calling the CADG approve API. Search for the CADGPlanCard or ExecutionPlanCard component. Check if the approve handler distinguishes between 'new message' and 'approve plan'. The approve endpoint is POST /api/cadg/plan/:planId/approve in server/src/routes/cadg.ts."
    },
    {
      "id": "US-008",
      "title": "Fix Onboarding Wizard hang at Analysis step in Demo Mode",
      "description": "As a CSM in Demo Mode, the Onboarding Wizard should complete all steps, not hang at Step 3 Analysis.",
      "acceptanceCriteria": [
        "Find the Onboarding Wizard component (components/AgentStudio/OnboardingFlow.tsx or similar)",
        "Identify the Analysis step (Step 3) that calls an AI endpoint for contract parsing",
        "Add Demo Mode detection: if no auth/Google tokens available, use simulated analysis results",
        "Simulate with 2-3 second delay for realism, then return pre-built analysis data",
        "Pre-built data should include: customer info, 3-5 stakeholders, 4-6 entitlements, and recommendations",
        "Wizard should proceed through all remaining steps after simulated analysis",
        "Test: Demo Mode onboarding wizard completes all steps without hanging",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "The onboarding wizard Step 3 likely calls a contract analysis endpoint that requires Google OAuth tokens to access Google Drive/Docs. In Demo Mode without Google auth, this times out. Fix: check for auth before making the API call, and if unavailable, return mock analysis data. Look for the component that handles the Analysis phase — it may be in components/UnifiedOnboarding.tsx or a step component. The backend endpoint might be in server/src/services/contractParser.ts or server/src/routes/contracts.ts."
    },
    {
      "id": "US-009",
      "title": "Fix CSV export and add Demo Mode graceful fallback",
      "description": "As a CSM, CSV export on Execution Plans should work or show a clear limitation message.",
      "acceptanceCriteria": [
        "Find the CSV export handler (search for 'export', 'csv', 'download' in CADG-related components)",
        "If export relies on Google Docs API: add Demo Mode fallback that generates CSV from the execution plan data directly",
        "If export endpoint doesn't exist: implement basic CSV generation from plan structure data (columns: Step, Description, Status, Assignee)",
        "Replace generic 'Export failed' error with specific message: 'Export requires Google Workspace integration' in Demo Mode",
        "Test: clicking export in Demo Mode shows helpful message or generates CSV from local data",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Every export attempt in Demo Mode shows 'Export failed'. The export may try to fetch from Google Docs URLs that aren't accessible. Fix: generate CSV directly from the execution plan's structure data stored in the plan object, without requiring Google integration. The plan object from CADG contains structure with steps that can be exported as CSV."
    },
    {
      "id": "US-010",
      "title": "Integration verification — end-to-end QA retest",
      "description": "As a developer, verify all fixes work together in both Demo and Authenticated modes.",
      "acceptanceCriteria": [
        "Demo Mode: Select Risk agent, ask 'Run a risk assessment on TechStart Inc' — routes to Risk, uses TechStart data, generates risk assessment (not Stakeholder Map)",
        "Demo Mode: Ask 'What should I focus on this week?' — gets conversational response, not Execution Plan",
        "Demo Mode: Generate an Execution Plan, click Approve — generates output, no duplicate",
        "Demo Mode: Customer dropdown shows all 33 customers",
        "Demo Mode: Start Onboarding Wizard — completes all steps",
        "Demo Mode: Click export on a card — shows helpful message or generates CSV",
        "All specialist agents (Onboarding, Adoption, Renewal, Risk, Strategic) route correctly when manually selected",
        "Auto-route picks appropriate specialist based on keywords",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "This is a verification story. Check that all previous fixes work together. Run through the full QA checklist from the mega prompt. If any integration issues are found, fix them. Focus on the critical path: select customer → select agent → ask question → get correct response."
    }
  ]
}
