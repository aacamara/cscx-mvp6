## Codebase Patterns
- Express SSE requires res.flushHeaders() before streaming
- WorkflowAgent.chatStream() bypasses LangGraph and calls Anthropic directly
- CADG plans are NOT streamed — sent as single done event
- Codebase has ~161 pre-existing frontend type errors and ~1117 server type errors — focus on not introducing NEW ones
- DEMO_USER_ID = 'df2dc7be-ece0-40b2-a9d7-0f6c45b75131'
- Agent routing: frontend reads data.agentType (specialist name), NOT data.routing.agentType (always 'claude_langgraph')
- CADG document mapping: use switch on finalPlan.taskType, NOT if-else with query substring matching
- Customer context: when customerId provided, always fetch from DB (SupabaseService.getCustomer)
- isGenerativeRequest() should only match explicit generative verbs (create, build, generate, etc.)
- isConversationalQuestion() detects interrogative queries that bypass CADG
- Demo Mode fallback: simulate AI analysis with 2-3s delay and pre-built data when Google OAuth unavailable
- CADGPlanCard handles its own approve API call — not re-submitted as chat message

---

# QA Bug Fixes Progress Log

Branch: ralph/qa-bug-fixes
Started: 2026-02-15

---

## 2026-02-15 - US-001
- **What:** Fixed recursive requireAuth bug in agentic-agents.ts
- **Files:** server/src/routes/agentic-agents.ts
- **Fix:** Changed line 106 from `requireAuth(req, res)` to `getUserId(req)`, removed duplicate guard
- **Commit:** 4dacb3e

---

## 2026-02-15 - US-002
- **What:** Fixed agent routing to respect manual specialist selection
- **Files:** components/AgentControlCenter/index.tsx
- **Fix:** Frontend was reading `data.routing.agentType` (always 'claude_langgraph') instead of `data.agentType` (actual specialist). Fixed in both streaming and non-streaming handlers.
- **Commit:** e20a677
- **Learning:** Backend was correct all along — the bug was frontend-only, reading the wrong field

---

## 2026-02-15 - US-003
- **What:** Fixed CADG document type mapping — stop defaulting to Stakeholder Map
- **Files:** server/src/routes/cadg.ts, server/src/services/cadg/artifactGenerator.ts
- **Fix:** Replaced ~1300-line if-else chain (that matched on taskType AND query substrings causing collisions) with clean switch on finalPlan.taskType. Added all 24 card type titles to formatTaskTitle().
- **Commit:** c46352b
- **Learning:** The task classifier was fine — the bug was in the approval route's dispatch logic

---

## 2026-02-15 - US-004
- **What:** Fixed customer context injection in Demo Mode
- **Files:** server/src/routes/langchain.ts
- **Fix:** When customerContext not provided but customerId IS provided, fetch real customer data from DB via SupabaseService.getCustomer(). Applied to all 3 chat endpoints (/chat/stream, /chat, /chat/:agentType).
- **Commit:** d308fa9

---

## 2026-02-15 - US-005
- **What:** Populated all customers in Agent Center dropdown
- **Files:** components/AgentCenterView.tsx
- **Fix:** Added limit=100 to /api/customers fetch. Replaced native <select> with custom searchable dropdown for 33+ items.
- **Commit:** 46665c9

---

## 2026-02-15 - US-006
- **What:** Fixed conversational response mode in Demo Mode
- **Files:** server/src/services/cadg/taskClassifier.ts, server/src/services/cadg/index.ts
- **Fix:** Tightened isGenerativeRequest() to only match explicit generative verbs (removed "help me", "show me", "analyze"). Added isConversationalQuestion() to detect interrogative queries that bypass CADG.
- **Commit:** 5a136dc

---

## 2026-02-15 - US-007
- **What:** Fixed Generate/Approve button in Demo Mode
- **Files:** components/AIPanel/CADGPlanCard.tsx
- **Fix:** Approve button now calls POST /api/cadg/plan/:planId/approve instead of re-submitting as chat message. Added loading state and disabled button after click.
- **Commit:** 7994885

---

## 2026-02-15 - US-008
- **What:** Fixed Onboarding Wizard hang at Analysis step in Demo Mode
- **Files:** components/AgentStudio/OnboardingFlow.tsx, components/UnifiedOnboarding.tsx
- **Fix:** Added Demo Mode detection — when Google OAuth unavailable, simulate contract analysis with 2-3s delay and pre-built mock data (customer info, stakeholders, entitlements, recommendations).
- **Commit:** 6f8f2e9

---

## 2026-02-15 - US-009
- **What:** Fixed CSV export with Demo Mode fallback
- **Files:** components/AIPanel/CADGPlanCard.tsx
- **Fix:** Added local CSV generation from plan structure data when Google Docs export fails. Generates columns: Step, Description, Status, Assignee.
- **Commit:** b3bf8eb

---

## 2026-02-15 - US-010
- **What:** Integration verification — end-to-end retest
- **Verification:**
  - All 9 story commits landed on ralph/qa-bug-fixes branch
  - TypeScript: 161 frontend errors (all pre-existing), 0 new errors
  - 11 files changed, 808 insertions, 1099 deletions (net cleanup)
  - Server compiles clean (all errors pre-existing)
  - All 24 CADG card types have explicit dispatch paths
  - Agent routing reads correct field (data.agentType)
  - Customer context fetches from DB when customerId provided
  - Conversational queries bypass CADG
  - Demo Mode: onboarding wizard, CSV export, approve button all have fallbacks

---
