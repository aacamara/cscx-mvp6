# Weekly Garbage Collection Agent
# Runs Monday at 9am UTC. Scans for code quality issues and opens fix PRs.
# Inspired by OpenAI's "garbage collection" pattern from Harness Engineering.

name: Weekly Cleanup

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9am UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  cleanup:
    name: Garbage Collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci && cd server && npm ci

      - name: Run org-filter audit
        id: org-audit
        run: |
          # Run the full org filter lint (not --changed-only)
          OUTPUT=$(bash scripts/lint-org-filter.sh 2>&1 || true)
          echo "$OUTPUT"

          # Count errors
          ERROR_COUNT=$(echo "$OUTPUT" | grep -c "^ERROR:" || echo "0")
          WARNING_COUNT=$(echo "$OUTPUT" | grep -c "^WARNING:" || echo "0")
          echo "org_errors=${ERROR_COUNT}" >> $GITHUB_OUTPUT
          echo "org_warnings=${WARNING_COUNT}" >> $GITHUB_OUTPUT

          # Save for the report
          echo "$OUTPUT" > /tmp/org-audit.txt
        continue-on-error: true

      - name: Run TypeScript error census
        id: ts-census
        run: |
          # Count total TS errors for tracking over time
          SERVER_ERRORS=$(npx tsc --noEmit --pretty false --project server/tsconfig.json 2>&1 | grep -c "error TS" || echo "0")
          FRONTEND_ERRORS=$(npx tsc --noEmit --pretty false 2>&1 | grep -c "error TS" || echo "0")

          echo "server_errors=${SERVER_ERRORS}" >> $GITHUB_OUTPUT
          echo "frontend_errors=${FRONTEND_ERRORS}" >> $GITHUB_OUTPUT
          echo "total_errors=$((SERVER_ERRORS + FRONTEND_ERRORS))" >> $GITHUB_OUTPUT

          echo "Server TS errors: ${SERVER_ERRORS}"
          echo "Frontend TS errors: ${FRONTEND_ERRORS}"
        continue-on-error: true

      - name: Check for stale docs
        id: docs-check
        run: |
          STALE_COUNT=0

          # Check if QUALITY_SCORE.md has been updated this month
          QUALITY_FILE="docs/quality/QUALITY_SCORE.md"
          if [ -f "$QUALITY_FILE" ]; then
            LAST_MODIFIED=$(git log -1 --format="%ci" -- "$QUALITY_FILE" 2>/dev/null || echo "never")
            echo "QUALITY_SCORE.md last modified: ${LAST_MODIFIED}"

            # Check if it's older than 30 days
            if [ "$LAST_MODIFIED" != "never" ]; then
              DAYS_AGO=$(( ($(date +%s) - $(date -d "$LAST_MODIFIED" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S %z" "$LAST_MODIFIED" +%s 2>/dev/null || echo "0")) / 86400 ))
              if [ "$DAYS_AGO" -gt 30 ]; then
                STALE_COUNT=$((STALE_COUNT + 1))
                echo "QUALITY_SCORE.md is ${DAYS_AGO} days old — needs update"
              fi
            fi
          fi

          echo "stale_count=${STALE_COUNT}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Update quality score
        if: steps.ts-census.outputs.total_errors != ''
        run: |
          # Update the quality score with current error counts
          QUALITY_FILE="docs/quality/QUALITY_SCORE.md"

          if [ -f "$QUALITY_FILE" ]; then
            # Update the error counts in the file
            SERVER_ERRORS="${{ steps.ts-census.outputs.server_errors }}"
            FRONTEND_ERRORS="${{ steps.ts-census.outputs.frontend_errors }}"
            DATE=$(date +%Y-%m-%d)

            # Update the overall section
            sed -i.bak "s/Server TS errors.*$/Server TS errors**: ~${SERVER_ERRORS}/" "$QUALITY_FILE" 2>/dev/null || true
            sed -i.bak "s/Frontend TS errors.*$/Frontend TS errors**: ~${FRONTEND_ERRORS}/" "$QUALITY_FILE" 2>/dev/null || true
            sed -i.bak "s/Last Updated.*/Last Updated\n\n${DATE}/" "$QUALITY_FILE" 2>/dev/null || true
            rm -f "${QUALITY_FILE}.bak"
          fi

      - name: Create cleanup PR if changes exist
        id: create-pr
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            BRANCH="chore/weekly-cleanup-$(date +%Y%m%d)"
            git checkout -b "$BRANCH"
            git config user.name "claude-code[bot]"
            git config user.email "claude-code[bot]@users.noreply.github.com"
            git add -A
            git commit -m "$(cat <<'EOF'
          chore(cleanup): weekly quality score update

          Automated weekly cleanup by the garbage collection agent.
          Updates TypeScript error counts and quality metrics.

          Co-Authored-By: Claude Code <noreply@anthropic.com>
          EOF
            )"
            git push origin "$BRANCH"
            echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
            echo "has_pr=true" >> $GITHUB_OUTPUT
          else
            echo "has_pr=false" >> $GITHUB_OUTPUT
            echo "No changes to commit."
          fi

      - name: Open PR
        if: steps.create-pr.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "chore(cleanup): weekly quality update $(date +%Y-%m-%d)" \
            --body "$(cat <<'EOF'
          ## Weekly Garbage Collection

          Automated cleanup by the Code Factory garbage collection agent.

          ### Changes
          - Updated TypeScript error counts in `docs/quality/QUALITY_SCORE.md`

          ### Current Metrics
          - Server TS errors: ${{ steps.ts-census.outputs.server_errors }}
          - Frontend TS errors: ${{ steps.ts-census.outputs.frontend_errors }}
          - Org filter audit errors: ${{ steps.org-audit.outputs.org_errors }}
          - Org filter audit warnings: ${{ steps.org-audit.outputs.org_warnings }}

          ---
          _Weekly Cleanup v1.0 · [How We Build](docs/HOW_WE_BUILD.md)_
          EOF
          )" \
            --label "risk:low" \
            --head "${{ steps.create-pr.outputs.branch }}" \
            --base main

      - name: Post weekly summary to issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const serverErrors = '${{ steps.ts-census.outputs.server_errors }}' || '?';
            const frontendErrors = '${{ steps.ts-census.outputs.frontend_errors }}' || '?';
            const orgErrors = '${{ steps.org-audit.outputs.org_errors }}' || '?';
            const orgWarnings = '${{ steps.org-audit.outputs.org_warnings }}' || '?';
            const hasPr = '${{ steps.create-pr.outputs.has_pr }}' === 'true';
            const date = new Date().toISOString().split('T')[0];

            const title = `Weekly Cleanup Report: ${date}`;
            const body = `## Weekly Garbage Collection Report

            **Date:** ${date}

            ### TypeScript Error Census
            | Project | Errors |
            |---------|--------|
            | Server | ${serverErrors} |
            | Frontend | ${frontendErrors} |
            | **Total** | **${parseInt(serverErrors || 0) + parseInt(frontendErrors || 0)}** |

            ### Org Filter Audit
            - Errors (missing auth): ${orgErrors}
            - Warnings (missing org filter): ${orgWarnings}

            ### Actions Taken
            ${hasPr ? '- Opened PR with quality score update' : '- No changes needed'}

            ---
            _[How We Build](docs/HOW_WE_BUILD.md) · Risk Policy: \`.github/risk-policy.json\`_`;

            // Create as an issue for tracking history
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['risk:low'],
            });
