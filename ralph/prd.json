{
  "project": "CSCX.AI",
  "branchName": "ralph/cadg-fuzzy-and-buttons",
  "description": "Two improvements: (1) Fuzzy/semantic CADG trigger matching so natural language variations work, (2) Map agent quick-action buttons to CADG cards so clicking buttons invokes CADG flow with editable previews.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add synonym expansion to task classifier",
      "description": "As a user, I want the classifier to understand synonyms so 'put together a business review' matches 'qbr_generation'.",
      "acceptanceCriteria": [
        "Add SYNONYMS map to server/src/services/cadg/taskClassifier.ts",
        "Include synonyms for: create/build/generate/make/prepare/draft/set up/put together/design/compose",
        "Include synonyms for: plan/strategy/roadmap/blueprint/playbook/approach/framework",
        "Include synonyms for: review/assessment/evaluation/analysis/audit/check/overview",
        "Include synonyms for: meeting/call/session/sync/discussion/conversation",
        "Include synonyms for: customer/client/account/company/organization",
        "Include synonyms for: risk/danger/threat/concern/issue/problem/warning",
        "Include synonyms for: renewal/contract/subscription/license/agreement",
        "Apply synonym expansion to queries BEFORE keyword matching",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Added SYNONYMS map with 7 synonym families (actions, plans, reviews, meetings, customers, risks, renewals), expandWithSynonyms() function, updated classify/matchKeywords/matchPhrasePatterns to use synonym-expanded queries."
    },
    {
      "id": "US-002",
      "title": "Add word-level fuzzy matching with stemming",
      "description": "As a user, I want the classifier to handle word variations like 'forecasting' matching 'forecast'.",
      "acceptanceCriteria": [
        "Modify matchKeywords() in taskClassifier.ts to use tokenized word matching",
        "Add basic stemming: strip -ing, -ed, -s, -tion suffixes for matching",
        "Add stop word removal: ignore 'a', 'the', 'for', 'to', 'me', 'my', 'our', 'this', 'that', 'can', 'you', 'please', 'help', 'need', 'want', 'would', 'like', 'I'",
        "Score individual word matches not just exact phrase includes",
        "Multi-word keyword matches still score higher than single words",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Added STOP_WORDS set (30 words), basicStem() function (strips -tion, -ing, -ed, -s), tokenize() helper, and updated matchKeywords() with two-tier matching: exact substring first (1.5x multiplier for multi-word), then stemmed word-level fallback. Content words used for normalization (stop words excluded from denominator)."
    },
    {
      "id": "US-003",
      "title": "Lower LLM fallback threshold and upgrade model",
      "description": "As a user, I want ambiguous queries to be classified by the LLM even when partial keyword matches exist.",
      "acceptanceCriteria": [
        "Change LLM fallback threshold from 0.5 to 0.3 in classifyTask()",
        "Add secondary LLM check when confidence is between 0.3 and 0.7",
        "Update model from claude-3-haiku-20240307 to claude-haiku-4-5-20251001",
        "Add timeout of 3 seconds for LLM classification",
        "If LLM fails, use best keyword match as fallback",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Lowered LLM fallback threshold from 0.5 to 0.3, added secondary LLM check for medium-confidence zone (0.3-0.7), upgraded model to claude-haiku-4-5-20251001, added 3s AbortController timeout, LLM failures fall back to best keyword match."
    },
    {
      "id": "US-004",
      "title": "Add contextual agent boosting",
      "description": "As a user, I want queries to prefer the currently active agent's card types when ambiguous.",
      "acceptanceCriteria": [
        "Accept optional activeAgent parameter in classifyTask()",
        "If activeAgent is provided, boost confidence of that agent's task types by +0.15",
        "Agent-to-task-type mapping: onboarding=[kickoff_plan,milestone_plan,stakeholder_map,training_schedule], adoption=[usage_analysis,feature_campaign,champion_development,training_program], renewal=[renewal_forecast,value_summary,expansion_proposal,negotiation_brief], risk=[risk_assessment,save_play,escalation_report,resolution_plan], strategic=[qbr_generation,executive_briefing,account_plan,transformation_roadmap]",
        "Only apply boost when multiple task types have similar scores (within 0.1)",
        "Update the classifyTask function signature and callers",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Added ActiveAgentType and AGENT_TASK_TYPES mapping to taskClassifier.ts. Refactored matchKeywords into matchKeywordsWithScores (returns all raw scores) + matchKeywords wrapper. Added applyAgentBoosting() function that boosts agent task types by +0.15 when within 0.1 of best score. Updated classify() signature to accept optional activeAgent. Updated cadgService.classify() in index.ts to pass activeAgent through. Updated langchain.ts to extract activeAgent from request body. Updated cadg.ts /plan route to accept activeAgent. Frontend sends activeAgent field alongside forceAgent."
    },
    {
      "id": "US-005",
      "title": "Update AGENT_ACTIONS IDs to match CADG TaskTypes",
      "description": "As a developer, I need the agent button IDs to match CADG task type strings for direct routing.",
      "acceptanceCriteria": [
        "Update components/AgentControlCenter/AgentCard.tsx AGENT_ACTIONS",
        "Onboarding: kickoff→kickoff_plan, plan_30_60_90→milestone_plan, keep stakeholder_map, add training_schedule, keep meeting_prep",
        "Adoption: keep usage_analysis, adoption_campaign→feature_campaign, feature_training→training_program (reuse for training), champion_program→champion_development",
        "Renewal: keep renewal_forecast, keep value_summary, expansion_analysis→expansion_proposal, renewal_playbook→negotiation_brief, keep draft_email",
        "Risk: keep risk_assessment, keep save_play, escalation→escalation_report, health_check→resolution_plan, remove churn_prediction",
        "Strategic: qbr_prep→qbr_generation, exec_briefing→executive_briefing, keep account_plan, success_plan→transformation_roadmap, keep draft_email",
        "Add cadgTaskType field to actions that should trigger CADG cards",
        "Update button labels to match card names",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Updated AGENT_ACTIONS with AgentAction interface (id, label, icon, cadgTaskType?). Renamed IDs: kickoff→kickoff_plan, plan_30_60_90→milestone_plan, welcome_sequence→training_schedule, adoption_campaign→feature_campaign, feature_training→training_program, champion_program→champion_development, expansion_analysis→expansion_proposal, renewal_playbook→negotiation_brief, escalation→escalation_report, health_check→resolution_plan, churn_prediction removed, qbr_prep→qbr_generation, exec_briefing→executive_briefing, success_plan→transformation_roadmap. Added cadgTaskType field to all CADG-routable actions. Non-CADG actions (meeting_prep, draft_email) kept without cadgTaskType. Updated actionMessages in handleAgentAction to use new IDs."
    },
    {
      "id": "US-006",
      "title": "Add buildCadgTriggerMessage helper function",
      "description": "As a developer, I need a function that generates the optimal CADG trigger message for each task type.",
      "acceptanceCriteria": [
        "Add buildCadgTriggerMessage(taskType, customerName) to AgentControlCenter/index.tsx",
        "Returns a message string containing the exact CADG keyword for that task type",
        "Includes customer name context when available",
        "Covers all 24 CADG task types",
        "General mode tasks don't include customer name",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added buildCadgTriggerMessage(taskType, customerName?) function to AgentControlCenter/index.tsx. Covers all 24 CADG task types. General Mode tasks (portfolio_dashboard, team_metrics, renewal_pipeline, at_risk_overview) return messages without customer context. Customer-specific tasks use exact CADG keywords (e.g., 'Create a kickoff plan for X') that match PHRASE_PATTERNS in taskClassifier.ts. Falls back to generic message for unknown task types."
    },
    {
      "id": "US-007",
      "title": "Update handleAgentAction to use CADG routing",
      "description": "As a user, clicking a CADG button should invoke the CADG card flow instead of plain chat.",
      "acceptanceCriteria": [
        "Modify handleAgentAction() in components/AgentControlCenter/index.tsx",
        "Check if action has cadgTaskType property",
        "If cadgTaskType exists, use buildCadgTriggerMessage() to create the message",
        "Send the message via sendToAgent() which routes through CADG classifier",
        "Non-CADG actions (draft_email, meeting_prep, schedule_meeting) still use old behavior",
        "Remove the old actionMessages fallback for CADG-mapped actions",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add General Mode quick-action buttons",
      "description": "As a user in General Mode (no customer selected), I want portfolio-level CADG buttons.",
      "acceptanceCriteria": [
        "When customer is null or General Mode is active, show general_mode actions",
        "Add 4 general mode actions: portfolio_dashboard, team_metrics, renewal_pipeline, at_risk_overview",
        "These buttons appear in the same quick-actions area or as suggested actions",
        "Clicking them triggers CADG flow without customer context",
        "Hide customer-specific CADG buttons when no customer is selected",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add inline suggested action chips in chat welcome",
      "description": "As a user, I want to see clickable CADG action chips when I enter the Agent Center.",
      "acceptanceCriteria": [
        "Update the welcome message area to show agent-specific CADG chips",
        "Chips appear below the 'Onboarding Specialist Ready' (or equivalent) message",
        "Each chip triggers its CADG card when clicked",
        "Chips match the current active agent's card types",
        "Style: rounded pills with icon + label, consistent with existing chip design",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Integration test: verify button-to-CADG-card flow end-to-end",
      "description": "As a developer, I need to verify the full flow from button click to CADG card display.",
      "acceptanceCriteria": [
        "Verify that clicking each CADG button sends the correct trigger message",
        "Verify the trigger message is correctly classified by the task classifier",
        "Verify the response includes the CADG plan card (CADGPlanCard component)",
        "Test at least one button per agent type (5 total)",
        "Verify General Mode buttons work without customer context",
        "Document any issues found in notes",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ]
}
