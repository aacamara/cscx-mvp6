## Codebase Patterns
- Express SSE requires res.flushHeaders() before streaming
- Use res.write() not res.send() for streaming
- Set Cache-Control: no-cache header
- AbortController handles client disconnects
- Anthropic SDK streaming: anthropic.messages.stream({...}) returns Stream object
- Stream events: stream.on('text', callback) for token deltas
- stream.finalMessage() returns the complete Anthropic.Message after stream ends
- WorkflowAgent.chat() at line 2724 of WorkflowAgent.ts — mirror this for chatStream()
- anthropic instance initialized at line 985-987 of WorkflowAgent.ts
- APPROVAL_REQUIRED_TOOLS list determines which tools need HITL approval
- executeReadOnlyTool() handles auto-approved tool execution
- Existing SSE infrastructure in server/src/routes/agents.ts lines 219-468 (use as reference)
- Existing SSE consumer parseSSEData in components/AIPanel/index.tsx line 226
- sendToAgentRegular() at line 885 of components/AgentControlCenter/index.tsx — this is what needs streaming
- The /api/ai/chat route at line 446 of langchain.ts — the streaming variant goes before it
- CADG detection in langchain.ts lines 479-543 — copy this logic for stream endpoint, but send as done event
- Session persistence in langchain.ts lines 546-562 — same for stream endpoint
- WorkflowAgent call in langchain.ts lines 567-614 — replace with chatStream() call
- Message types in AgentControlCenter use { agent, message, isApproval, routing, toolResults } shape
- Codebase has ~80 pre-existing type errors - focus on not introducing NEW ones
- Use `useAuth().getAuthHeaders()` for authenticated API calls
- Brand colors: cscx-accent (#e63946 red), cscx-black (#000000), cscx-gray-900 (#0a0a0a), cscx-gray-800 (#222222)
- chatStream() bypasses LangGraph graph and calls Anthropic directly — LangGraph doesn't support streaming callbacks
- System prompt in chatStream() is duplicated from callClaude() — future refactor opportunity
- WorkflowAgent.chatStream() added after chat() in WorkflowAgent class — same file, same class
- SSE streaming route at /api/ai/chat/stream added in langchain.ts BEFORE /chat route
- sendSSE() helper in langchain.ts — local to file, decoupled from agents.ts sendSSEEvent()
- CADG plans are sent as single done events (not streamed) — plan creation is fast, no need to stream
- Non-Claude fallbacks send their response as a single done event since they don't support streaming
- Always guard res.write() with clientDisconnected check to avoid "write after end" errors

---

# Streaming v2 Progress Log

Initialized: Ready to start US-001

---

## 2026-02-05 - US-001
- What was implemented: Added `chatStream()` method to WorkflowAgent class
- Files changed: `server/src/langchain/agents/WorkflowAgent.ts`
- **Details:**
  - `chatStream()` mirrors `chat()` parameters plus: `onToken` callback, `onToolEvent` callback, `abortSignal`
  - Uses `anthropic.messages.stream()` instead of `anthropic.messages.create()`
  - Listens for `text` events on stream and calls `onToken(text)` for each delta
  - After stream completes, uses `stream.finalMessage()` to get full response
  - Processes tool_use blocks identically to `callClaude()` — checks APPROVAL_REQUIRED_TOOLS, executes read-only tools, creates pendingActions
  - Calls `onToolEvent` with `tool_start`/`tool_end` around each tool execution with timing
  - Creates approval requests via approvalService for pending actions
  - Handles `abortSignal` by calling `stream.abort()` and returning empty response
  - Returns same Promise shape as `chat()`
- **Learnings for future iterations:**
  - `chat()` uses LangGraph `this.graph.invoke()` — but the actual Anthropic call is in `callClaude()` (line 2230)
  - `chatStream()` bypasses the graph and directly calls Anthropic API — necessary because LangGraph doesn't support streaming callbacks
  - The system prompt is duplicated between `callClaude()` and `chatStream()` — consider extracting to a shared function
  - `stream.abort()` can be called to cancel generation mid-stream
  - AbortSignal listeners need cleanup — use `{ once: true }` and clean up on stream end
---

## 2026-02-05 - US-002
- What was implemented: Added `POST /api/ai/chat/stream` SSE endpoint in `server/src/routes/langchain.ts`
- Files changed: `server/src/routes/langchain.ts`
- **Details:**
  - Added `sendSSE()` helper function (writes `data: JSON.stringify(event)\n\n`)
  - New route placed BEFORE existing `POST /chat` route
  - Sets SSE headers: Content-Type, Cache-Control, Connection, X-Accel-Buffering + flushHeaders()
  - Tracks client disconnect via `req.on('close')` and `req.on('aborted')`
  - CADG handling: classifies request, if generative with ≥0.7 confidence, creates plan and sends single `done` event (no streaming for CADG)
  - Session handling: same as `/chat` — getOrCreateSession(), addMessage(), getConversationHistory()
  - WorkflowAgent streaming: calls `chatStream()` with `onToken` → `{type:'token', content}` and `onToolEvent` → `{type:'tool_start'/'tool_end', ...}`
  - After stream completes, sends `done` event with full metadata JSON (response, agentType, routing, toolsUsed, toolResults, requiresApproval, pendingActions, sessionId)
  - Saves assistant response to session after stream completes
  - Non-Claude fallbacks (action handler, Google query, orchestrator) run normally and send response as single `done` event
  - Error handling: wraps everything in try/catch, sends `{type:'error', error}` then `res.end()`
  - TypeScript: `npx tsc --noEmit` passes with no NEW errors (all errors are pre-existing)
- **Learnings for future iterations:**
  - The streaming route mirrors `/chat` logic 1:1 but replaces `res.json()` with SSE events
  - CADG plans are NOT streamed — they're instant since plan creation is fast
  - Non-Claude fallbacks (Gemini-based action/Google/orchestrator handlers) don't support streaming — wrap their responses as single `done` events
  - `sendSSE()` is a local helper, not imported from agents.ts, to keep the files decoupled
  - Always check `clientDisconnected` before writing to res to avoid "write after end" errors
  - The streaming route at `/chat/stream` must be registered BEFORE `/chat` otherwise Express matches `/chat` first
---
