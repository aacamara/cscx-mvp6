# Ralph Progress Log
# Project: CSCX.AI CADG Complete Cards
# Branch: ralph/cadg-complete-cards
# Started: 2026-02-04

## Codebase Patterns
- CADG preview components follow a consistent pattern: bg-cscx-gray-800 container, sticky header with gradient, accent colors (teal/purple/blue)
- Use `useAuth().getAuthHeaders()` for authenticated API calls
- List operations: always generate unique IDs with `Date.now()` pattern
- AI suggestions: use `/api/cadg/{type}/suggest` endpoints with `fieldType`, `currentValue`, `customerId`
- TypeScript: export types alongside component for external use
- **New TaskTypes require updates to**: contextAggregator.ts (TASK_KEYWORDS), reasoningEngine.ts (DEFAULT_SECTIONS, OUTPUT_FORMATS, estimateLength)
- **Data aggregation**: Use `dataHelpers.aggregateCustomerContext()` for customer-specific cards, `aggregatePortfolioContext()` for General Mode cards

---

## Session 1: 2026-02-03

### Completed User Stories

#### US-001: Add intent classification endpoint ‚úÖ
- Added POST `/api/agents/intent/classify` endpoint in `server/src/routes/agents.ts`
- Uses Claude AI to classify message intent
- Returns `{ agent, confidence, reasoning }`
- Fallback to 'general' on error (graceful degradation)
- Uses fast model for < 500ms response

#### US-002: Wire frontend intent classifier to backend API ‚úÖ
- Updated `classifyIntent` in `components/AgentControlCenter/index.tsx`
- Now async function that calls backend endpoint
- 300ms debounce with AbortController for cancellation
- Falls back to local regex classifier if backend fails
- Shows classification result in input hint

#### US-003: Update saveChatMessage to persist status ‚úÖ
- Updated `server/src/routes/chat.ts` POST /api/chat/messages
- Added `status` and `client_id` fields to insert
- Changed to upsert with `onConflict: 'client_id'` for deduplication
- Updated batch insert to include status/client_id
- Interface extended with optional status and client_id

#### US-004: Update getChatHistory to return message status ‚úÖ
- Updated GET /api/chat/history select to include `status, client_id`
- Frontend now receives and displays status from backend

#### US-005: Implement real optimistic updates with reconciliation ‚úÖ
- `handleSend` generates client-side UUID with `crypto.randomUUID()`
- Message added to UI immediately with `status: 'sending'`
- `saveChatMessage` updated to use client_id for deduplication
- On success: updates message with server ID, status to 'sent'
- On failure: sets status to 'failed'
- Functional setState pattern prevents race conditions

#### US-006: Wire retry button ‚úÖ
- `handleRetryMessage` calls `sendToAgent` with existing messageId
- Same client_id used for deduplication
- Status updates: failed ‚Üí sending ‚Üí sent/failed

#### US-007: Fix offline queue with exponential backoff ‚úÖ
- Added `retryCountsRef` to track retry attempts per message
- Queue processing uses exponential backoff with jitter
- Max 3 retries before marking as failed
- Messages removed from queue on max retries
- Process queue called on online event

#### US-008: Fix contract parsing database ‚úÖ
- Updated `server/src/services/supabase.ts` saveContract method
- Optional columns (total_value, start_date, end_date) handled gracefully
- If insert fails due to missing columns, retries without them
- Works whether or not migration is run

### Files Modified
- `server/src/routes/agents.ts` - Added intent classify endpoint
- `server/src/routes/chat.ts` - Added status/client_id, upsert
- `server/src/services/supabase.ts` - Optional column handling
- `components/AgentControlCenter/index.tsx` - Backend classifier, optimistic updates

### Documentation Updated
- `docs/plans/2026-02-03-fix-chat-production-wiring-plan.md` - Enhanced with research insights

### Next Steps
- Run migrations in Supabase (if not done)
- Manual testing of all features
- Run E2E tests

---

## 2026-02-04 - US-003
- **What was implemented**: Generic editable preview component (CADGEditablePreview.tsx)
- **Files changed**:
  - `components/AIPanel/CADGEditablePreview.tsx` (created, 901 lines)
- **Features**:
  - Schema-driven field rendering (text, textarea, date, dropdown, slider, toggle, etc.)
  - List management: add/remove/reorder items (both simple and complex lists)
  - Multi-dropdown selection for owner assignments
  - Date and datetime pickers for timeline fields
  - Collapsible sections with defaultCollapsed option
  - AI Enhance button with suggestion apply/dismiss flow
  - Data sources panel display
  - Accent color theming (teal, purple, blue, red, green, yellow, orange)
  - Unsaved changes warning on cancel
  - Matches MeetingScheduler styling with consistent UI patterns
- **Learnings for future iterations**:
  - The component uses a schema-driven approach - define `PreviewSchema` with sections and fields, and it renders automatically
  - Field types: 'text', 'textarea', 'date', 'datetime', 'dropdown', 'multi-dropdown', 'list', 'list-complex', 'slider', 'toggle', 'number'
  - AI enhancement calls `/api/cadg/enhance` endpoint - needs backend implementation
  - Existing TypeScript errors in codebase are pre-existing, not from this change
---

## 2026-02-04 - US-004, US-005
- **What was implemented**: Complete TaskType mappings for all CADG services
- **Files changed**:
  - `server/src/services/cadg/contextAggregator.ts` - Added TASK_KEYWORDS for all 23 new task types
  - `server/src/services/cadg/reasoningEngine.ts` - Added DEFAULT_SECTIONS, OUTPUT_FORMATS, and estimateLength for all 23 new task types
- **Key findings**:
  - US-004 endpoint (GET /api/cadg/artifact/:artifactId/download) already existed in cadg.ts lines 428-502
  - US-005 endpoint (GET /api/cadg/artifact/:artifactId/export-sources) already existed in cadg.ts lines 508-600
  - Both endpoints use driveService.exportFile() which was already implemented
  - The type system needed completion to support all new TaskTypes in the Record types
- **Learnings for future iterations**:
  - When adding new TaskTypes to types.ts, MUST also update: contextAggregator.ts TASK_KEYWORDS, reasoningEngine.ts DEFAULT_SECTIONS, OUTPUT_FORMATS, and estimateLength
  - Record<TaskType, T> requires ALL keys from the TaskType union - TypeScript will error if any are missing
  - Pre-existing TypeScript errors in other files (mcp/, artifactGenerator.ts) don't affect the CADG routes functionality
---

## 2026-02-04 - US-006
- **What was implemented**: Shared data aggregation helpers for CADG generators
- **Files changed**:
  - `server/src/services/cadg/dataHelpers.ts` (created, ~900 lines)
  - `server/src/services/cadg/index.ts` (updated exports)
- **Features**:
  - `aggregateCustomerContext()` - Gathers Customer360, health trends, engagement metrics, risk signals, interactions, renewal forecast, stakeholders, contracts
  - `aggregatePortfolioContext()` - For General Mode cards (no customer required), aggregates total customers, ARR, health distribution, renewal pipeline, at-risk customers, team metrics, CSM info
  - `getPlaybooksByType()` - Fetches playbooks by type (onboarding, adoption, renewal, risk, expansion, qbr, etc.) from knowledge base
  - `formatDataForDocument()` - Prepares data structure for Google Docs/Slides/Sheets with sections and metadata
- **Types exported**:
  - CustomerContext, PortfolioContext, Stakeholder, ContractInfo
  - RenewalPipelineItem, AtRiskCustomer, TeamMetrics, CSMInfo
  - PlaybookType, DocumentData, DocumentSection, DocumentMetadata
- **Learnings for future iterations**:
  - Use `Array.from(map.entries()).forEach()` instead of `for...of` on Maps to avoid downlevelIteration issues
  - Cast unknown metadata properties explicitly: `(r.metadata?.category as string)`
  - When creating risk level types, consider context - AtRiskCustomer excludes 'low' since they're already at risk
  - All helper functions handle missing database gracefully by returning empty defaults
---

## 2026-02-04 - US-007
- **What was implemented**: Kickoff plan generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateKickoffPlanPreview()` function
  - `server/src/routes/cadg.ts` - Added kickoff_plan detection and `/api/cadg/kickoff-plan/save` endpoint
  - `components/AIPanel/CADGKickoffPlanPreview.tsx` (created, ~650 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added kickoff plan preview state and handlers
- **Features**:
  - **generateKickoffPlanPreview()**: Uses Claude to generate kickoff plan with:
    - Meeting title, date, duration
    - Attendees list (name, email, role)
    - Agenda items (topic, duration, owner)
    - Goals list
    - Next steps with action, owner, due date
    - Notes section
  - **CADGKickoffPlanPreview component**:
    - Collapsible sections for Attendees, Agenda, Goals, Next Steps
    - Full CRUD for all lists (add/remove/reorder)
    - Role dropdown (Executive Sponsor, Project Lead, Key User, etc.)
    - Duration dropdown (5-60 min)
    - Owner dropdown (CSM, Customer, Implementation Team, Support, All)
    - Date picker for meeting date and next step due dates
    - Unsaved changes warning
    - Teal accent color theme matching other preview components
  - **Backend endpoint**: POST `/api/cadg/kickoff-plan/save` creates Google Doc with formatted content
- **Learnings for future iterations**:
  - Kickoff plans use `isKickoffPlanPreview: true` response type (distinct from `isDocumentPreview`)
  - New preview components should export types (KickoffPlanData, CustomerData, etc.) for CADGPlanCard imports
  - Preview detection in cadg.ts should check both taskType AND user query patterns
  - Document content formatting uses markdown with tables for next steps
---

## 2026-02-04 - US-008
- **What was implemented**: Milestone plan (30-60-90 day) generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateMilestonePlanPreview()` function (~280 lines)
  - `server/src/routes/cadg.ts` - Added milestone_plan detection and `/api/cadg/milestone-plan/save` endpoint
  - `components/AIPanel/CADGMilestonePlanPreview.tsx` (created, ~600 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added milestone plan preview state and handlers
- **Features**:
  - **generateMilestonePlanPreview()**: Uses Claude to generate 30-60-90 day plan with:
    - Plan title and start date
    - Three phases (30, 60, 90 days) with configurable names
    - Goals per phase with completion checkboxes
    - Milestones with target dates and owners
    - Success criteria per phase
    - Notes section
  - **CADGMilestonePlanPreview component**:
    - Tab-based phase navigation (green/blue/purple color coding)
    - Phase header editing (name, days label)
    - Goals with checkboxes for completion tracking
    - Milestones with date pickers and owner dropdowns
    - Success criteria editing
    - Unsaved changes warning
    - Purple accent color theme
  - **Backend endpoint**: POST `/api/cadg/milestone-plan/save`:
    - Creates Google Doc with formatted markdown content
    - Creates Google Sheets tracker with all milestones across phases
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Milestone plans use `isMilestonePlanPreview: true` response type
  - Phase-based UI works well with tab navigation rather than collapsible sections
  - Color-coded phases (green/blue/purple) help users track progress visually
  - Creating both Doc and Sheet for plans provides document + tracking benefits
  - Query detection patterns should match multiple variations: '30-60-90', '30 60 90', 'milestone plan', 'first 90 days'
---

## 2026-02-04 - US-009
- **What was implemented**: Stakeholder map generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateStakeholderMapPreview()` function (~250 lines)
  - `server/src/routes/cadg.ts` - Added stakeholder_map detection and `/api/cadg/stakeholder-map/save` endpoint
  - `components/AIPanel/CADGStakeholderMapPreview.tsx` (created, ~550 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added stakeholder map preview state and handlers
- **Features**:
  - **generateStakeholderMapPreview()**: Uses Claude to generate stakeholder map with:
    - Stakeholder list with name, title, email
    - Role classification: Champion, Sponsor, Blocker, Evaluator, User
    - Influence level (1-5 slider)
    - Engagement level: High, Medium, Low
    - Notes per stakeholder
    - Relationships between stakeholders
  - **CADGStakeholderMapPreview component**:
    - Expandable contact cards with full editing
    - Role dropdown with color-coded styling per role
    - Influence slider with visual feedback
    - Engagement level dropdown
    - Relationship management (add/remove/edit)
    - Role legend with icons
    - Unsaved changes warning
    - Orange accent color theme
  - **Backend endpoint**: POST `/api/cadg/stakeholder-map/save`:
    - Creates Google Doc with formatted stakeholder details table
    - Attempts to create Google Slides visual (simplified version)
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Stakeholder maps use `isStakeholderMapPreview: true` response type
  - Color-coded role classifications help identify stakeholder types at a glance
  - Expandable cards work well for detailed stakeholder info (click to expand)
  - Relationships need name-to-ID mapping when parsing AI response
  - Query detection patterns: 'stakeholder map', 'stakeholder analysis', 'key contacts', 'org chart', 'contact map'
---

## 2026-02-04 - US-010
- **What was implemented**: Training schedule generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateTrainingSchedulePreview()` function (~200 lines)
  - `server/src/routes/cadg.ts` - Added training_schedule detection and `/api/cadg/training-schedule/save` endpoint
  - `components/AIPanel/CADGTrainingSchedulePreview.tsx` (created, ~690 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added training schedule preview state and handlers
- **Features**:
  - **generateTrainingSchedulePreview()**: Uses Claude to generate training schedule with:
    - Training sessions with name, description
    - Date, time, and duration per session
    - Trainer assignment (CSM, Product Expert, Implementation Team, etc.)
    - Attendee groups (multi-select)
    - Topics to cover per session
    - Prerequisites if any
  - **CADGTrainingSchedulePreview component**:
    - Expandable session cards with full editing
    - Session management: add/remove/reorder sessions
    - Date and time pickers for scheduling
    - Duration dropdown (30/45/60/90/120 min)
    - Trainer dropdown
    - Attendee group toggles (All Users, Admins, Power Users, End Users, etc.)
    - Topics list with add/remove
    - Prerequisites list with add/remove
    - Unsaved changes warning
    - Cyan accent color theme
  - **Backend endpoint**: POST `/api/cadg/training-schedule/save`:
    - Creates Google Doc with formatted training schedule
    - Creates Google Sheets calendar with session tracking
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Training schedules use `isTrainingSchedulePreview: true` response type
  - Session-based UI with expand/collapse works well for training schedules
  - Attendee group toggles are more intuitive than multi-select dropdowns for known options
  - Creating both Doc and Sheet provides documentation + calendar tracking
  - Query detection patterns: 'training schedule', 'training calendar', 'training plan', 'training sessions', 'schedule training'
---

## 2026-02-04 - US-011
- **What was implemented**: Usage analysis generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateUsageAnalysisPreview()` function (~200 lines)
  - `server/src/routes/cadg.ts` - Added usage_analysis detection and `/api/cadg/usage-analysis/save` endpoint
  - `components/AIPanel/CADGUsageAnalysisPreview.tsx` (created, ~1070 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added usage analysis preview state and handlers
- **Features**:
  - **generateUsageAnalysisPreview()**: Uses Claude to generate usage analysis with:
    - Title and configurable time range (preset or custom)
    - Metrics list with name, value, unit, trend, and included toggle
    - Feature adoption data with adoption rate, active users, trend
    - User segments with count, percentage, engagement levels
    - Recommendations with priority, category, and impact
    - Chart type toggles (trend, adoption, segment, heatmap)
    - Notes section
  - **CADGUsageAnalysisPreview component**:
    - Tab-based navigation for Metrics, Features, Segments, Recommendations
    - Time range preset selector (Last 7/30/90 days, Custom)
    - Chart type toggles in settings section
    - Full CRUD for all data types (add/remove/edit)
    - Priority badges (high/medium/low) for recommendations
    - Trend indicators with up/down/stable arrows
    - Include/exclude toggles for selective export
    - Unsaved changes warning
    - Emerald accent color theme
  - **Backend endpoint**: POST `/api/cadg/usage-analysis/save`:
    - Creates Google Doc with formatted usage analysis content
    - Creates Google Sheets with raw metrics data
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Usage analysis uses `isUsageAnalysisPreview: true` response type
  - Tab-based UI works well for multi-category data (metrics, features, segments, recommendations)
  - Include/exclude toggles allow users to customize what gets exported
  - Chart type toggles give users control over visualization options
  - Query detection patterns: 'usage analysis', 'usage report', 'analyze usage', 'feature adoption', 'adoption report', 'engagement analysis', 'user activity report'
---

## 2026-02-04 - US-012
- **What was implemented**: Feature campaign generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateFeatureCampaignPreview()` function (~350 lines)
  - `server/src/routes/cadg.ts` - Added feature_campaign detection and `/api/cadg/feature-campaign/save` endpoint
  - `components/AIPanel/CADGFeatureCampaignPreview.tsx` (created, ~1000 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added feature campaign preview state and handlers
- **Features**:
  - **generateFeatureCampaignPreview()**: Uses Claude to generate feature adoption campaign with:
    - Campaign title and goal
    - Target features with current/target adoption rates and priority
    - User segments with size, usage, and potential rating
    - Campaign timeline with phases and activities
    - Messaging templates for different channels (email, in-app, webinar, training, slack)
    - Success metrics with current vs target values
  - **CADGFeatureCampaignPreview component**:
    - Tab-based navigation for Features, Segments, Timeline, Messaging, Metrics
    - Target features with include/exclude toggles, adoption progress bars
    - User segments with potential rating dropdowns
    - Campaign phases with expandable cards and activity management
    - Messaging templates with channel icons and full editing
    - Success metrics with progress bars and goal tracking
    - Rose/pink accent color theme
  - **Backend endpoint**: POST `/api/cadg/feature-campaign/save`:
    - Creates Google Doc with formatted campaign plan
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Feature campaigns use `isFeatureCampaignPreview: true` response type
  - Tab-based UI with 5 tabs works well for complex multi-section content
  - Progress bars help users visualize current vs target adoption
  - Expandable cards work well for phases and messaging templates
  - Query detection patterns: 'feature campaign', 'drive adoption', 'increase adoption', 'adoption campaign', 'feature rollout', 'promote feature', 'underutilized features', 'boost usage'
---

## 2026-02-04 - US-013
- **What was implemented**: Champion development generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateChampionDevelopmentPreview()` function (~520 lines)
  - `server/src/routes/cadg.ts` - Added champion_development detection and `/api/cadg/champion-development/save` endpoint
  - `components/AIPanel/CADGChampionDevelopmentPreview.tsx` (created, ~1400 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added champion development preview state and handlers
- **Features**:
  - **generateChampionDevelopmentPreview()**: Uses Claude to generate champion development program with:
    - Program title and goal
    - Champion candidates with name, role, email, engagement score, NPS score, potential level, strengths, development areas
    - Development activities with category (training, recognition, networking, contribution, leadership), frequency, owner
    - Recognition rewards with type (recognition, access, swag, event, certificate), criteria
    - Program timeline with milestones
    - Success metrics with current vs target values
  - **CADGChampionDevelopmentPreview component**:
    - Tab-based navigation for Candidates, Activities, Rewards, Timeline, Metrics
    - Expandable candidate cards with full editing (strengths, development areas)
    - Activity management with category icons and enable/disable toggles
    - Reward management with type icons and criteria editing
    - Milestone timeline with numbered badges
    - Success metrics with progress bars
    - Amber accent color theme
  - **Backend endpoint**: POST `/api/cadg/champion-development/save`:
    - Creates Google Doc with formatted champion program content
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Champion development uses `isChampionDevelopmentPreview: true` response type
  - Tab-based UI with 5 tabs follows the same pattern as feature campaign
  - Expandable cards with checkboxes work well for selectable candidates
  - Category icons make activity and reward types easy to identify visually
  - Query detection patterns: 'champion development', 'champion program', 'develop champions', 'customer champions', 'champion candidates', 'identify champions', 'nurture champions', 'power users', 'advocate program'
---

## 2026-02-04 - US-014
- **What was implemented**: Training program generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateTrainingProgramPreview()` function (~400 lines)
  - `server/src/routes/cadg.ts` - Added training_program detection and `/api/cadg/training-program/save` endpoint (~175 lines)
  - `components/AIPanel/CADGTrainingProgramPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added training program preview state and handlers
- **Features**:
  - **generateTrainingProgramPreview()**: Uses Claude to generate comprehensive training curriculum with:
    - Program title and learning goal
    - Training modules with name, description, duration, order
    - Learning objectives and assessment criteria per module
    - Prerequisites per module
    - Resources (video, document, quiz, hands-on, webinar)
    - Target audience with current and target skill levels
    - Program timeline (start/end dates, total duration)
    - Completion criteria (attendance, assessment, project, certification)
    - Success metrics with current vs target values
  - **CADGTrainingProgramPreview component**:
    - Tab-based navigation for Modules, Audience, Criteria, Timeline, Metrics
    - Expandable module cards with full editing
    - Module reordering with up/down controls
    - Learning objectives list with add/remove
    - Assessment criteria list with add/remove
    - Prerequisites list with add/remove
    - Resource management with type icons (video/document/quiz/hands-on/webinar)
    - Target audience cards with skill level progression (beginner ‚Üí intermediate ‚Üí advanced)
    - Completion criteria toggles with required score for assessments
    - Timeline tab with module schedule visualization
    - Success metrics with progress bars
    - Violet accent color theme
  - **Backend endpoint**: POST `/api/cadg/training-program/save`:
    - Creates Google Doc with formatted curriculum content
    - Creates Google Sheets tracker for module progress
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Training program uses `isTrainingProgramPreview: true` response type
  - Training programs are curricula (modules with learning objectives) vs training schedules (calendar of sessions)
  - When creating Google Sheets without a template, don't pass template property - just omit it
  - Skill level visualization with color-coded badges works well (green/blue/purple for beginner/intermediate/advanced)
  - Query detection patterns: 'training program', 'training curriculum', 'learning program', 'training modules', 'training course', 'learning path', 'onboarding curriculum', 'certification program'
---

## 2026-02-04 - US-015
- **What was implemented**: Renewal forecast generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateRenewalForecastPreview()` function (~350 lines)
  - `server/src/routes/cadg.ts` - Added renewal_forecast detection and `/api/cadg/renewal-forecast/save` endpoint
  - `components/AIPanel/CADGRenewalForecastPreview.tsx` (created, ~1200 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added renewal forecast preview state and handlers
- **Features**:
  - **generateRenewalForecastPreview()**: Uses Claude to generate renewal probability analysis with:
    - Overall renewal probability (0-100%)
    - Probability scoring factors with weights
    - Risk factors with severity and negative impacts
    - Positive signals with strength and positive impacts
    - Recommended actions with priority, owner, due date, status
    - Historical context note
  - **CADGRenewalForecastPreview component**:
    - Tab-based navigation for Overview, Factors, Risks, Signals, Actions
    - Real-time probability calculation based on factors and toggled risks/signals
    - Probability overview card with probability bar and target indicator
    - Key metrics cards: ARR, days until renewal, contract term, gap to target
    - Probability factors with weight/score sliders and contribution display
    - Toggleable risk factors with severity badges and negative impact values
    - Toggleable positive signals with strength badges and positive impact values
    - Recommended actions with priority/owner/due date/status management
    - Action reordering with up/down controls
    - Unsaved changes warning
    - Teal/cyan accent color theme
  - **Backend endpoint**: POST `/api/cadg/renewal-forecast/save`:
    - Creates Google Sheets forecast model with probability factors, summary calculations
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Renewal forecast uses `isRenewalForecastPreview: true` response type
  - Real-time probability calculation: base (weighted factors) + risk impacts (negative) + signal impacts (positive)
  - Toggle-based risks/signals allow users to selectively include factors that apply
  - HealthTrend type doesn't have 'trend' property - use 'score' instead for recent health data
  - Query detection patterns: 'renewal forecast', 'renewal prediction', 'renewal probability', 'renewal likelihood', 'forecast renewal', 'predict renewal', 'renewal outlook', 'renewal projections', 'will they renew', 'renewal risk', 'renewal chance'
---

## 2026-02-04 - US-016
- **What was implemented**: Value summary generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateValueSummaryPreview()` function (~300 lines)
  - `server/src/routes/cadg.ts` - Added value_summary detection and `/api/cadg/value-summary/save` endpoint (~200 lines)
  - `server/src/services/google/qbrSlides.ts` - Added `createValueSummaryPresentation()` method (~600 lines)
  - `components/AIPanel/CADGValueSummaryPreview.tsx` (created, ~1150 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added value summary preview state and handlers
- **Features**:
  - **generateValueSummaryPreview()**: Uses Claude to generate value summary with:
    - Executive summary
    - Value metrics (efficiency, cost savings, revenue, productivity, satisfaction)
    - Success stories with categories (implementation, adoption, expansion, innovation, support)
    - Customer testimonials with author/title/quote
    - ROI calculation with auto-computed metrics (ROI %, payback months, 3-year value)
    - Key highlights and next steps
  - **CADGValueSummaryPreview component**:
    - Tab-based navigation for Overview, Metrics, Stories, Testimonials, ROI
    - Value metrics with include/exclude checkboxes, category badges, unit selection
    - Success stories with expandable cards, category dropdown, date picker
    - Testimonials with quote editing, author/title fields
    - ROI tab with auto-calculated metrics (investment + benefit = ROI%, payback, 3yr value)
    - Key highlights and next steps list management
    - Unsaved changes warning
    - Emerald/teal accent color theme
  - **Backend endpoint**: POST `/api/cadg/value-summary/save`:
    - Creates Google Slides presentation with 8 slides (title, summary, metrics, stories, testimonials, ROI, highlights, next steps)
    - Falls back to Google Doc if slides creation fails
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Value summary uses `isValueSummaryPreview: true` response type
  - Customer360 has `industryCode` property, not `industry` - use correct property name
  - ROI calculation should auto-compute derived values (roiPercentage, paybackMonths, threeYearValue) when investment or benefit changes
  - Include/exclude toggles on items allow users to customize what appears in final presentation
  - createValueSummaryPresentation method in qbrSlides.ts creates multi-slide presentations programmatically
  - Query detection patterns: 'value summary', 'value realization', 'roi summary', 'roi report', 'roi calculation', 'success metrics', 'value delivered', 'business value', 'customer value', 'demonstrate value', 'show value', 'prove value', 'value report'
---

## 2026-02-04 - US-017
- **What was implemented**: Expansion proposal generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateExpansionProposalPreview()` function (~350 lines)
  - `server/src/routes/cadg.ts` - Added expansion_proposal detection and `/api/cadg/expansion-proposal/save` endpoint (~200 lines)
  - `components/AIPanel/CADGExpansionProposalPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added expansion proposal preview state and handlers (~120 lines)
- **Features**:
  - **generateExpansionProposalPreview()**: Uses Claude to generate expansion proposal with:
    - Proposal title, dates, current/proposed ARR
    - Expansion products with category, current/proposed plans, pricing
    - Pricing options with discounts, terms, recommended flag
    - Business case items with categories (efficiency, revenue, cost_savings, risk_reduction, competitive)
    - ROI projection with auto-calculated metrics
    - Usage gaps and growth signals
    - Next steps
  - **CADGExpansionProposalPreview component**:
    - Tab-based navigation for Overview, Products, Pricing, Business Case, ROI
    - Expandable product cards with include/exclude toggles
    - Pricing options with recommended badge management
    - Business case items with category dropdown and impact editing
    - Auto-calculated ROI (roiPercentage, paybackMonths from investment/benefit)
    - Growth signals and usage gaps list editing
    - Violet/purple accent color theme
  - **Backend endpoint**: POST `/api/cadg/expansion-proposal/save`:
    - Creates Google Doc with formatted proposal content
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Expansion proposal uses `isExpansionProposalPreview: true` response type
  - EngagementMetrics doesn't have `activeUsers` property - use `dauMau` as proxy instead
  - docsService.createDocument takes (userId, options) - don't pass customerId in options
  - Calculate totals dynamically from included products in the component
  - Query detection patterns: 'expansion proposal', 'upsell proposal', 'growth proposal', 'upgrade proposal', 'account expansion', 'pricing proposal', 'cross-sell'
---

## 2026-02-04 - US-018
- **What was implemented**: Negotiation brief generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateNegotiationBriefPreview()` function (~330 lines) with types for ContractTerm, LeveragePoint, CounterStrategy, WalkAwayPoint
  - `server/src/routes/cadg.ts` - Added negotiation_brief detection and `/api/cadg/negotiation-brief/save` endpoint (~200 lines)
  - `components/AIPanel/CADGNegotiationBriefPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added negotiation brief preview state and handlers (~115 lines)
- **Features**:
  - **generateNegotiationBriefPreview()**: Uses Claude to generate negotiation brief with:
    - Title, negotiation date, contract value, contract term
    - Current terms with priority levels (must_have, important, nice_to_have)
    - Leverage points with strength (strong, moderate, weak) and categories (value_delivered, relationship, market_position, strategic_fit, timing)
    - Counter-strategies for objections with categories (price, scope, timeline, terms, competition)
    - Walk-away points with severity levels (critical, important, minor)
    - Competitor intelligence list
    - Value delivered list
    - Internal notes section
  - **CADGNegotiationBriefPreview component**:
    - Tab-based navigation for Overview, Terms, Leverage, Counter, Walk-Away
    - Key metrics cards: Contract Value, Days to Renewal, Leverage Points, Walk-Away Points
    - Expandable contract term cards with priority badges
    - Leverage points with enable/disable checkboxes, strength badges, category badges
    - Counter-strategy cards with category classification
    - Walk-away points with severity indicators
    - Value delivered and competitor intel list editing
    - Internal notes textarea
    - Unsaved changes warning
    - Indigo/violet accent color theme
  - **Backend endpoint**: POST `/api/cadg/negotiation-brief/save`:
    - Creates Google Doc with formatted markdown content
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Negotiation brief uses `isNegotiationBriefPreview: true` response type
  - Toggle checkboxes for leverage points allow selective inclusion in final document
  - Priority, strength, and severity indicators help users quickly assess importance
  - Counter-strategies pair objection with response and evidence for comprehensive preparation
  - Query detection patterns: 'negotiation brief', 'negotiation prep', 'negotiation strategy', 'renewal negotiation', 'contract negotiation', 'negotiate renewal', 'prepare negotiation', 'leverage points', 'counter strategy', 'walk-away', 'walkaway', 'bargaining', 'deal terms'
---

## 2026-02-04 - US-019
- **What was implemented**: Risk assessment generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateRiskAssessmentPreview()` function (~290 lines)
  - `server/src/routes/cadg.ts` - Added risk_assessment detection and `/api/cadg/risk-assessment/save` endpoint (~200 lines)
  - `components/AIPanel/CADGRiskAssessmentPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added risk assessment preview state and handlers (~115 lines)
- **Features**:
  - **generateRiskAssessmentPreview()**: Uses Claude to generate comprehensive risk assessment with:
    - Overall risk score (0-100) with automatic risk level classification
    - Risk factors with 8 categories: health, engagement, support, nps, usage, relationship, financial, competitive
    - Severity levels: critical, high, medium, low with corresponding weights
    - Mitigation actions with owner assignment, due dates, priorities, status tracking
    - Related risk IDs linking actions to specific risks
    - Executive summary
  - **CADGRiskAssessmentPreview component**:
    - Tab-based navigation for Overview, Risk Factors, Mitigation Actions, Summary
    - Real-time risk score calculation based on enabled factors and weights
    - Risk factor cards with enable/disable checkboxes, severity/category badges, weight sliders
    - Mitigation action cards with reordering, CRUD operations, owner dropdown, priority/status selectors
    - Related risks linking - click to toggle which risks each action addresses
    - Executive summary textarea
    - Risk breakdown by category in overview
    - Unsaved changes warning
    - Red/orange accent color theme
  - **Backend endpoint**: POST `/api/cadg/risk-assessment/save`:
    - Creates Google Doc with formatted risk assessment content
    - Creates Google Sheets tracker with two tabs: Mitigation Actions, Risk Factors
    - Logs activity for customer timeline
- **Learnings for future iterations**:
  - Risk assessment uses `isRiskAssessmentPreview: true` response type
  - Use `AssessmentRiskFactor` type to avoid conflict with existing `RiskFactor` type (used in renewal forecast)
  - GoogleSheet interface uses `id` and `webViewLink`, not `spreadsheetId` and `url`
  - Use `sheetsService.updateValues()` method (not `updateSheet`) to populate spreadsheet data
  - Risk calculation: weighted average of severity scores for enabled factors
  - Query detection patterns: 'risk assessment', 'risk analysis', 'churn risk', 'at-risk', 'at risk', 'assess risk', 'evaluate risk', 'risk profile', 'risk factors', 'mitigation plan', 'health risk'
---

## 2026-02-04 - US-020
- **What was implemented**: Save play generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateSavePlayPreview()` function (~290 lines) with types for RootCause, SavePlayAction, SuccessMetric, SavePlayPreviewResult
  - `server/src/routes/cadg.ts` - Added save_play detection and `/api/cadg/save-play/save` endpoint (~250 lines)
  - `components/AIPanel/CADGSavePlayPreview.tsx` (created, ~1050 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added save play preview state and handlers (~70 lines)
- **Features**:
  - **generateSavePlayPreview()**: Uses Claude to generate save play with:
    - Title, created date, risk level, situation summary
    - Root causes with categories (product, service, relationship, value, competitive, budget, timing, other)
    - Severity levels (critical, high, medium, low) and evidence per cause
    - Action items with owners, priorities, due dates, status tracking, and linked root causes
    - Success metrics with current and target values, target dates
    - Timeline for the save effort
  - **CADGSavePlayPreview component**:
    - Tab-based navigation for Overview, Root Causes, Actions, Metrics
    - Root cause cards with enable/disable checkboxes, category/severity badges
    - Action items with priority/status management and related causes linking
    - Success metrics with current ‚Üí target value display
    - Reordering controls for action items
    - Unsaved changes warning
    - Orange accent color theme
  - **Backend endpoint**: POST `/api/cadg/save-play/save`:
    - Creates Google Doc with formatted save play content
    - Creates Google Sheets tracker with three tabs: Action Items, Root Causes, Success Metrics
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Save play uses `isSavePlayPreview: true` response type
  - Root causes use categories distinct from risk factors (product, service, relationship, value, competitive, budget, timing, other)
  - Action items can link to multiple root causes via `relatedCauseIds` array
  - Success metrics use `enabled` toggle for selective inclusion in final document
  - Query detection patterns: 'save play', 'save this customer', 'save the customer', 'save account', 'churn save', 'retention play', 'retention plan', 'prevent churn', 'rescue plan', 'intervention plan', 'turnaround plan', 'win back'
---

## 2026-02-04 - US-021
- **What was implemented**: Escalation report generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateEscalationReportPreview()` function (~390 lines) with types for TimelineEvent, ImpactMetric, SupportingEvidence, ResolutionRequest, EscalationReportPreviewResult
  - `server/src/routes/cadg.ts` - Added escalation_report detection and `/api/cadg/escalation-report/save` endpoint (~250 lines)
  - `components/AIPanel/CADGEscalationReportPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added escalation report preview state and handlers (~120 lines)
- **Features**:
  - **generateEscalationReportPreview()**: Uses Claude to generate escalation report with:
    - Title, escalation level (critical/high/medium), issue summary
    - Customer context (name, ARR, health score, days until renewal)
    - Primary contact and escalation owner
    - Timeline events with date, event name, description, severity, actor
    - Impact metrics with severity and business impact descriptions
    - Resolution requests with priority (urgent/high/medium/low), owner, due date, status
    - Supporting evidence with type (email/ticket/meeting/document/screenshot/log/other)
    - Recommended actions summary
  - **CADGEscalationReportPreview component**:
    - Tab-based navigation for Overview, Timeline, Impact, Requests, Evidence
    - Timeline events with numbered badges, enable/disable checkboxes, severity/actor badges
    - Impact metrics with expandable cards for editing
    - Resolution requests with reordering controls, priority/status/owner dropdowns
    - Supporting evidence with type badges and optional URL links
    - Recommended actions textarea
    - Unsaved changes warning
    - Red/rose accent color theme
  - **Backend endpoint**: POST `/api/cadg/escalation-report/save`:
    - Creates Google Doc with formatted markdown content
    - Tables for timeline, impact metrics, resolution requests
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Escalation report uses `isEscalationReportPreview: true` response type
  - Timeline events sorted chronologically by date
  - Resolution requests use `priority: 'urgent'` level (distinct from other cards that use critical/high/medium/low)
  - Supporting evidence has optional URL field for linking to external resources
  - Actor types: customer, csm, support, product, leadership, external
  - Query detection patterns: 'escalation report', 'escalation', 'escalate this', 'escalate issue', 'executive escalation', 'urgent escalation', 'escalate to', 'raise escalation', 'formal escalation', 'critical issue', 'create escalation'
---

## 2026-02-04 - US-022
- **What was implemented**: Resolution plan generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateResolutionPlanPreview()` function (~330 lines) with types for ResolutionIssue, ResolutionAction, ResolutionDependency, ResolutionPlanPreviewResult
  - `server/src/routes/cadg.ts` - Added resolution_plan detection and `/api/cadg/resolution-plan/save` endpoint (~250 lines)
  - `components/AIPanel/CADGResolutionPlanPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added resolution plan preview state and handlers (~120 lines)
- **Features**:
  - **generateResolutionPlanPreview()**: Uses Claude to generate resolution plan with:
    - Title, created date, target resolution date, overall status
    - Issues list with categories (product, service, integration, performance, usability, security, compliance, other)
    - Severity levels (critical, high, medium, low) and status tracking (open, in_progress, blocked, resolved)
    - Action items with owners, priorities, due dates, status, and linked issues
    - Dependencies with types (internal, external, customer, vendor) and blockedBy tracking
    - Timeline description
  - **CADGResolutionPlanPreview component**:
    - Tab-based navigation for Overview, Issues, Actions, Dependencies
    - Issue cards with enable/disable checkboxes, category/severity/status badges, expandable editing
    - Action items with reordering controls, related issues linking (click to toggle)
    - Dependency cards with type and blocker fields
    - Key metrics cards: Open Issues, Pending Actions, Health Score, Days to Renewal
    - Unsaved changes warning
    - Cyan accent color theme
  - **Backend endpoint**: POST `/api/cadg/resolution-plan/save`:
    - Creates Google Doc with formatted markdown content (issues, actions, dependencies)
    - Creates Google Sheets tracker with issues data
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Resolution plan uses `isResolutionPlanPreview: true` response type
  - Use `interactionHistory` property from context, not `recentInteractions`
  - For Google Sheets, use `sheetsService.createSpreadsheet()` not `createSheet()`
  - For Google Sheets updateValues, pass options object with `range` and `values` properties
  - Resolution plans link actions to issues via `relatedIssueIds` array
  - Query detection patterns: 'resolution plan', 'action plan', 'issue resolution', 'problem resolution', 'fix plan', 'remediation plan', 'corrective action', 'resolve issues', 'address issues', 'issue tracker', 'action tracker'
---

## 2026-02-04 - US-023
- **What was implemented**: Executive briefing generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateExecutiveBriefingPreview()` function (~360 lines) with types for ExecutiveHeadline, ExecutiveMetric, StrategicUpdate, ExecutiveAsk, ExecutiveBriefingPreviewResult
  - `server/src/routes/cadg.ts` - Added executive_briefing detection and `/api/cadg/executive-briefing/save` endpoint (~220 lines)
  - `server/src/services/google/qbrSlides.ts` - Added `createExecutiveBriefingPresentation()` method (~450 lines)
  - `components/AIPanel/CADGExecutiveBriefingPreview.tsx` (created, ~1100 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added executive briefing preview state and handlers (~70 lines)
- **Features**:
  - **generateExecutiveBriefingPreview()**: Uses Claude to generate executive briefing with:
    - Title, prepared for, prepared by, briefing date
    - Headlines with sentiment (positive/neutral/negative)
    - Key metrics with trend and category
    - Strategic updates with status and category
    - Asks with priority, owner, due date
    - Configurable slide count (5, 6, or 7 slides)
    - Next steps list
  - **CADGExecutiveBriefingPreview component**:
    - Tab-based navigation for Overview, Headlines, Metrics, Updates, Asks, Next Steps
    - Expandable cards for headlines, metrics, updates, and asks
    - Enable/disable checkboxes for selective inclusion
    - Slide count selector (5-7 slides)
    - Sentiment icons (‚úÖ/‚ûñ/‚ö†Ô∏è) for headlines
    - Trend indicators (‚Üë/‚Üì/‚Üí) for metrics
    - Status icons (‚úÖ/üîÑ/üìã/‚ö†Ô∏è) for updates
    - Priority icons (üî¥/üü°/üü¢) for asks
    - Reordering controls for asks
    - Unsaved changes warning
    - Indigo/purple accent color theme
  - **Backend endpoint**: POST `/api/cadg/executive-briefing/save`:
    - Creates Google Slides presentation with 5-7 slides
    - Falls back to Google Doc if slides creation fails
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Executive briefing uses `isExecutiveBriefingPreview: true` response type
  - Customer360 has `npsScore` property directly, not `npsHistory` array
  - Slide count is user-configurable (5, 6, or 7) to control presentation length
  - Tab-based UI with 6 tabs works well for comprehensive executive briefings
  - Content summary in Overview helps users see what will be included
  - Query detection patterns: 'executive briefing', 'exec briefing', 'executive summary', 'leadership briefing', 'board briefing', 'executive deck', 'executive presentation', 'brief leadership', 'leadership presentation', 'stakeholder briefing', 'account overview for exec', 'account brief'
---

## 2026-02-04 - US-024
- **What was implemented**: Account plan generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateAccountPlanPreview()` function (~450 lines) with types for AccountObjective, AccountAction, AccountMilestone, AccountResource, AccountPlanPreviewResult
  - `server/src/routes/cadg.ts` - Added account_plan detection and `/api/cadg/account-plan/save` endpoint (~395 lines)
  - `components/AIPanel/CADGAccountPlanPreview.tsx` (created, ~1300 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added account plan preview state and handlers (~127 lines)
- **Features**:
  - **generateAccountPlanPreview()**: Uses Claude to generate strategic account plan with:
    - Plan title, plan period, created date
    - Account overview (strategic summary)
    - Strategic objectives with categories (growth, retention, expansion, adoption, risk_mitigation, strategic)
    - Action items with owners, priorities, due dates, status tracking, and linked objectives
    - Milestones with target dates and status
    - Resource requirements (budget, headcount, tooling, training, support, other)
    - Success criteria list
    - Identified risks list
    - Timeline description
  - **CADGAccountPlanPreview component**:
    - Tab-based navigation for Overview, Objectives, Actions, Milestones, Resources, Criteria & Risks
    - Summary cards showing objectives, actions, milestones, resources counts
    - Expandable objective cards with category/priority badges, metrics management
    - Action items with reordering, related objectives linking (click to toggle)
    - Milestone cards with numbered badges, status tracking
    - Resources with type icons and allocation editing
    - Success criteria and identified risks list management
    - Unsaved changes warning
    - Indigo/purple accent color theme
  - **Backend endpoint**: POST `/api/cadg/account-plan/save`:
    - Creates Google Doc with formatted markdown content
    - Creates Google Sheets tracker with objectives, actions, milestones tabs
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Account plan uses `isAccountPlanPreview: true` response type
  - Tab-based UI with 6 tabs provides comprehensive account planning interface
  - sheetsService.updateValues requires 3 args: (userId, spreadsheetId, options) not 2
  - Related objectives linking in actions uses click-to-toggle pattern
  - Success criteria and risks are simple string lists vs complex objects
  - Query detection patterns: 'account plan', 'strategic plan', 'strategic account plan', 'account strategy', 'account roadmap', 'strategic roadmap', 'customer plan', 'annual plan', 'success plan', 'growth plan', 'engagement plan', 'partnership plan', 'relationship plan'
---

## 2026-02-04 - US-025
- **What was implemented**: Transformation roadmap generator with full HITL editable preview
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateTransformationRoadmapPreview()` function (~550 lines) with types for TransformationPhase, TransformationMilestone, TransformationSuccessCriterion, TransformationDependency, TransformationRisk, TransformationRoadmapPreviewResult
  - `server/src/routes/cadg.ts` - Added transformation_roadmap detection (~70 lines) and `/api/cadg/transformation-roadmap/save` endpoint (~250 lines)
  - `components/AIPanel/CADGTransformationRoadmapPreview.tsx` (created, ~1450 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added transformation roadmap preview state and handlers (~130 lines)
- **Features**:
  - **generateTransformationRoadmapPreview()**: Uses Claude to generate transformation roadmap with:
    - Vision statement, current state, target state
    - Transformation phases with objectives, deliverables, timeline, owner, status
    - Milestones linked to phases with target dates
    - Success criteria with categories (adoption, business, technical, operational, strategic)
    - Dependencies with types (internal, external, customer, vendor, technical)
    - Risks with likelihood, impact, and mitigation strategies
    - Key stakeholders list
  - **CADGTransformationRoadmapPreview component**:
    - Tab-based navigation for Overview, Phases, Milestones, Criteria, Dependencies, Risks
    - Summary cards showing counts for each category
    - Expandable phase cards with color-coded styling
    - Phase management: add objectives, add deliverables, edit timeline
    - Milestone management linked to phases
    - Success criteria with category badges and measurable toggle
    - Dependencies with type/status tracking
    - Risk cards with likelihood/impact indicators and mitigation editing
    - Key stakeholders list management
    - Unsaved changes warning
    - Violet/purple accent color theme
  - **Backend endpoint**: POST `/api/cadg/transformation-roadmap/save`:
    - Creates Google Doc with formatted roadmap content
    - Attempts to create Google Slides presentation (optional)
    - Logs activity to agent_activities table
- **Learnings for future iterations**:
  - Transformation roadmap uses `isTransformationRoadmapPreview: true` response type
  - qbrSlidesService is the correct export from qbrSlides.ts, not qbrSlides
  - Use `(service as any).methodName` for optional method calls on services
  - Phases are color-coded using PHASE_COLORS array to differentiate visually
  - Dependencies have their own status tracking (resolved/pending/blocked) separate from phases
  - Query detection patterns: 'transformation roadmap', 'transformation plan', 'digital transformation', 'transformation journey', 'change roadmap', 'transformation timeline', 'maturity roadmap', 'evolution roadmap', 'adoption roadmap', 'implementation roadmap', 'rollout roadmap', 'deployment roadmap'
---

## 2026-02-04 - US-026
- **What was implemented**: Portfolio dashboard generator with full HITL editable preview (General Mode)
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generatePortfolioDashboardPreview()` function (~375 lines) with types for PortfolioCustomerEntry, PortfolioSummary, PortfolioFilters, PortfolioColumn
  - `server/src/routes/cadg.ts` - Added portfolio_dashboard detection (~50 lines) and `/api/cadg/portfolio-dashboard/save` endpoint (~200 lines)
  - `components/AIPanel/CADGPortfolioDashboardPreview.tsx` (created, ~900 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added portfolio dashboard preview state and handlers (~120 lines)
- **Features**:
  - **generatePortfolioDashboardPreview()**: Aggregates portfolio data with:
    - Customer list with name, ARR, health score, tier, segment, renewal date, owner
    - Health distribution (healthy/at_risk/critical)
    - Summary metrics (total customers, total ARR, avg health, avg NPS)
    - Renewals this quarter count and ARR
    - Works in General Mode (no customer context required)
    - Uses dataHelpers.aggregatePortfolioContext() for real data
    - Falls back to sample data in template mode
  - **CADGPortfolioDashboardPreview component**:
    - Tab-based navigation for Overview, Customers, Filters, Columns
    - Health distribution progress bar with emerald/amber/red coloring
    - Filterable customer list with multi-select health/segment/tier/owner filters
    - Date range filter (all/this quarter/next quarter/this year/custom)
    - Sortable by name, ARR, health, renewal, NPS with asc/desc toggle
    - Column visibility toggles for export customization
    - Customer cards with health score, ARR, renewal countdown, status badge
    - Select All / Clear All for bulk customer selection
    - Unsaved changes warning
    - Blue/indigo accent color theme
  - **Backend endpoint**: POST `/api/cadg/portfolio-dashboard/save`:
    - Creates Google Sheets with customer data and enabled columns
    - Creates Google Doc summary with portfolio metrics and customer list
    - Logs activity to agent_activities table (no customer_id for General Mode)
- **Learnings for future iterations**:
  - Portfolio dashboard uses `isPortfolioDashboardPreview: true` response type
  - General Mode cards don't have customer context - set customerId to null in detection
  - Portfolio data comes from aggregatePortfolioContext() in dataHelpers.ts
  - For General Mode, don't include customer in preview data - only planId and dashboard data
  - Filter state needs all arrays (healthLevels, segments, tiers, owners) populated from availableX arrays
  - Query detection patterns: 'portfolio dashboard', 'portfolio overview', 'customer portfolio', 'my portfolio', 'all customers', 'all my customers', 'customer list', 'book of business', 'account list', 'show customers', 'customer health dashboard'
---

## 2026-02-04 - US-027
- **What was implemented**: Team metrics generator with full HITL editable preview (General Mode)
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateTeamMetricsPreview()` function (~350 lines) with types for CSMMetrics, TeamMetric, TeamMetricsFilters, TeamMetricsColumn, TeamMetricsSummary, TeamMetricsPreviewResult
  - `server/src/routes/cadg.ts` - Added team_metrics detection (~45 lines) and `/api/cadg/team-metrics/save` endpoint (~200 lines)
  - `components/AIPanel/CADGTeamMetricsPreview.tsx` (created, ~900 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added team metrics preview state and handlers (~100 lines)
- **Features**:
  - **generateTeamMetricsPreview()**: Aggregates CSM performance data with:
    - CSM metrics: customer count, ARR, health score, renewal/expansion/churn rates, NPS, activities, tickets
    - Team-level metrics with benchmarks and trends
    - Health distribution across all customers
    - Works in General Mode (no customer context required)
    - Uses dataHelpers.aggregatePortfolioContext() for real data
    - Falls back to sample data in template mode
  - **CADGTeamMetricsPreview component**:
    - Tab-based navigation for Overview, CSMs, Metrics, Filters, Columns
    - Summary cards: Total CSMs, Customers, ARR, Avg Health
    - Health distribution progress bar (healthy/at-risk/critical)
    - Key metrics cards with benchmark comparisons
    - CSM cards with enable/disable checkboxes, expandable details
    - Metric toggles with trend indicators (up/down/stable)
    - Time range filter (7/30/90 days, quarter, custom)
    - CSM filter multi-select
    - Sort options with asc/desc toggle
    - Show benchmarks toggle
    - Column visibility controls for export
    - Unsaved changes warning
    - Indigo/blue accent color theme
  - **Backend endpoint**: POST `/api/cadg/team-metrics/save`:
    - Creates Google Sheets with CSM data and enabled columns
    - Creates Google Doc report with team metrics summary
    - Creates optional Google Slides presentation
    - Logs activity to agent_activities table (no customer_id for General Mode)
- **Learnings for future iterations**:
  - Team metrics uses `isTeamMetricsPreview: true` response type
  - General Mode cards use same pattern as portfolio dashboard - set customerId to null
  - CSM data comes from aggregatePortfolioContext().csms in dataHelpers.ts
  - Benchmark comparisons use `showBenchmarks` toggle in filters
  - Trend indicators help users quickly see metric direction
  - Query detection patterns: 'team metrics', 'team performance', 'csm metrics', 'csm performance', 'team dashboard', 'manager dashboard', 'team report', 'csm report', 'team kpis', 'csm kpis', 'team health', 'compare csms', 'csm comparison', 'my team'
---

## 2026-02-04 - US-028
- **What was implemented**: Renewal pipeline generator with full HITL editable preview (General Mode)
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateRenewalPipelinePreview()` function (~350 lines) with types for RenewalPipelineEntry, RenewalPipelineSummary, RenewalPipelineFilters, RenewalPipelineColumn, RenewalPipelinePreviewResult
  - `server/src/routes/cadg.ts` - Added renewal_pipeline detection (~50 lines) and `/api/cadg/renewal-pipeline/save` endpoint (~220 lines)
  - `components/AIPanel/CADGRenewalPipelinePreview.tsx` (created, ~900 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added renewal pipeline preview state and handlers (~130 lines)
- **Features**:
  - **generateRenewalPipelinePreview()**: Aggregates renewal data with:
    - Renewal entries with customer name, ARR, renewal date, days until renewal, probability, health score, owner, risk level, tier, segment
    - Summary metrics: total renewals, total ARR, avg probability, avg health score, risk distribution (low/medium/high/critical), renewals this month/quarter
    - Works in General Mode (no customer context required)
    - Uses dataHelpers.aggregatePortfolioContext() for real data
    - Falls back to sample data in template mode
  - **CADGRenewalPipelinePreview component**:
    - Tab-based navigation for Overview, Renewals, Filters, Columns
    - Summary cards showing key metrics (total renewals, ARR, probability, health)
    - Risk distribution progress bar (emerald/amber/orange/red)
    - Filterable renewal list with enable/disable checkboxes
    - Date range filter (all, this month, this quarter, next quarter, next 6 months, this year, custom)
    - Risk level filter (low/medium/high/critical)
    - ARR threshold filter (min/max)
    - Owner and tier filters (multi-select)
    - Group by selector (none, month, quarter, owner, risk level, tier)
    - Sort options with direction toggle (renewal date, ARR, probability, health, customer name)
    - Column visibility controls for export customization
    - Select All / Clear All for bulk operations
    - Unsaved changes warning
    - Teal/cyan accent color theme
  - **Backend endpoint**: POST `/api/cadg/renewal-pipeline/save`:
    - Creates Google Sheets with renewal data and enabled columns
    - Creates Google Doc report with pipeline summary and renewal list
    - Logs activity to agent_activities table (no customer_id for General Mode)
- **Learnings for future iterations**:
  - Renewal pipeline uses `isRenewalPipelinePreview: true` response type
  - General Mode cards follow same pattern as portfolio dashboard and team metrics - set customerId to null
  - Renewal data comes from aggregatePortfolioContext().renewalPipeline in dataHelpers.ts
  - Risk levels use different colors than health: low (emerald), medium (amber), high (orange), critical (red)
  - Date range filtering needs separate handling for custom vs preset ranges
  - Query detection patterns: 'renewal pipeline', 'renewals pipeline', 'upcoming renewals', 'renewal forecast', 'renewal calendar', 'renewal schedule', 'renewal tracker', 'renewal list', 'renewals this quarter', 'renewals this month', 'renewals due', 'show renewals', 'all renewals'
---

## 2026-02-04 - US-029
- **What was implemented**: At-risk overview generator with full HITL editable preview (General Mode)
- **Files changed**:
  - `server/src/services/cadg/artifactGenerator.ts` - Added `generateAtRiskOverviewPreview()` function (~380 lines) with types for AtRiskCustomerEntry, AtRiskSummary, AtRiskFilters, AtRiskColumn, AtRiskOverviewPreviewResult
  - `server/src/routes/cadg.ts` - Added at_risk_overview detection (~50 lines) and `/api/cadg/at-risk-overview/save` endpoint (~250 lines)
  - `components/AIPanel/CADGAtRiskOverviewPreview.tsx` (created, ~900 lines)
  - `components/AIPanel/CADGPlanCard.tsx` - Added at-risk overview preview state and handlers (~130 lines)
- **Features**:
  - **generateAtRiskOverviewPreview()**: Aggregates at-risk customer data with:
    - Customer list with risk score, health score, primary risk factors, days at risk
    - Risk level classification (medium/high/critical)
    - Save play status tracking (active/completed/none)
    - Renewal urgency (within 30/90 days)
    - Works in General Mode (no customer context required)
    - Uses dataHelpers.aggregatePortfolioContext() for real data
    - Falls back to sample data in template mode
  - **CADGAtRiskOverviewPreview component**:
    - Tab-based navigation for Overview, Customers, Filters, Columns
    - Summary cards: At-Risk Customers, ARR at Risk, Avg Risk Score, Avg Health Score
    - Risk distribution progress bar (red/orange/amber for critical/high/medium)
    - Save play distribution cards
    - Renewal urgency indicators (within 30/90 days with ARR)
    - Risk threshold slider filter
    - Risk level filter toggle (medium/high/critical)
    - Save play filters (show only with/without save plays)
    - Renewal range filter (all/within 30/60/90 days/custom)
    - Owner/tier/segment multi-select filters
    - Sort options with direction toggle
    - Column visibility controls for export
    - Customer cards with primary risk factors
    - Select All / Clear All for bulk operations
    - Unsaved changes warning
    - Orange accent color theme
  - **Backend endpoint**: POST `/api/cadg/at-risk-overview/save`:
    - Creates Google Sheets with customer data and enabled columns
    - Creates Google Doc report with at-risk overview summary
    - Logs activity to agent_activities table (no customer_id for General Mode)
- **Learnings for future iterations**:
  - At-risk overview uses `isAtRiskOverviewPreview: true` response type
  - General Mode cards follow same pattern as portfolio dashboard, team metrics, renewal pipeline - set customerId to null
  - At-risk data comes from aggregatePortfolioContext().atRiskCustomers in dataHelpers.ts
  - Risk levels for at-risk overview are medium/high/critical (excludes 'low' since they're already at risk)
  - Risk score is inverse of health score for simplicity (100 - healthScore)
  - Save play status uses enabled/disabled pattern with status tracking
  - Query detection patterns: 'at-risk overview', 'at risk overview', 'at-risk customers', 'at risk customers', 'customers at risk', 'show at-risk', 'show at risk', 'risk overview', 'churn risk overview', 'high risk customers', 'critical customers', 'risky accounts', 'accounts at risk'
---
