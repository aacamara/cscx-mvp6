# PRD-2: Unified Knowledge Base with Google Drive Sync + Chat/Artifact Auto-Ingestion

**Status**: ðŸ”´ Not Started
**Priority**: P0 - Critical
**Last Updated**: 2026-02-01

---

## Goal

Extend KB so each user/workspace can connect Google Drive as a knowledge source. Any docs uploaded in chat or generated by CSCX are automatically stored/represented in KB. Chat can query back to these KB docs reliably.

---

## Scope

### In Scope
- Google Drive OAuth connection at workspace/personal scope
- Folder selection for indexing
- Initial sync + manual incremental sync
- Chat upload auto-ingestion to KB
- Generated artifact mirroring to KB
- KB UI with tabs, filters, search
- Chat retrieval with citations
- Permission enforcement

### Out of Scope
- Scheduled/webhook sync (Phase 2)
- External KB integrations (Notion, Confluence - future)

---

## User Stories

### US-1: Connect Drive as KB Source
**As a** user, **I want to** connect my Google Drive to KB, **So that** my Drive documents are searchable in the platform.

### US-2: Select Folders for Indexing
**As a** user, **I want to** select specific folders from Drive, **So that** only relevant documents are indexed.

### US-3: Chat Upload Auto-Ingestion
**As a** user, **I want** files I upload in chat to automatically appear in KB, **So that** they're retrievable later.

### US-4: Generated Artifact Mirroring
**As a** user, **I want** generated QBRs/reports to appear in KB, **So that** I can find them via search.

### US-5: Query KB in Chat
**As a** user, **I want to** ask questions in chat that search my KB, **So that** I get answers from my documents.

---

## Functional Requirements

### A) Drive as KB Source

| Req ID | Requirement |
|--------|-------------|
| FR-1.1 | Connect Drive via OAuth (workspace or personal scope) |
| FR-1.2 | Folder picker to select root folders for indexing |
| FR-1.3 | Initial sync downloads and indexes selected content |
| FR-1.4 | Manual "Resync" button triggers incremental update |
| FR-1.5 | Supported formats: Google Docs/Slides/Sheets (export), PDF, DOCX, TXT, MD |
| FR-1.6 | Unsupported formats stored as metadata + link only |
| FR-1.7 | Track etag/version to avoid reindexing unchanged docs |
| FR-1.8 | Handle deletions: soft delete from index (configurable) |

### B) Chat Upload Auto-Ingestion

| Req ID | Requirement |
|--------|-------------|
| FR-2.1 | Any file uploaded in chat is added to KB |
| FR-2.2 | Default namespace: Personal (toggle for Workspace) |
| FR-2.3 | Store file in Drive if connected; else internal storage |
| FR-2.4 | Extract text, chunk, embed, index |
| FR-2.5 | Failed extraction: keep metadata + link + error status |

### C) Artifact Mirroring

| Req ID | Requirement |
|--------|-------------|
| FR-3.1 | Generated outputs (QBRs, analyses) create KB entry |
| FR-3.2 | Source: "Generated by CSCX" with metadata |
| FR-3.3 | Link to Drive document |
| FR-3.4 | Extract summary for chat retrieval |

### D) KB UI

| Req ID | Requirement |
|--------|-------------|
| FR-4.1 | Tabs: Workspace KB | Personal KB |
| FR-4.2 | Filters: source, type, tags, date range |
| FR-4.3 | Keyword + semantic search |
| FR-4.4 | Document detail: link, status, last indexed, reindex button |
| FR-4.5 | Move between namespaces |

### E) Chat Retrieval

| Req ID | Requirement |
|--------|-------------|
| FR-5.1 | Retrieve from workspace + user's personal KB only |
| FR-5.2 | Never access other users' personal KB |
| FR-5.3 | Provide citations/links in responses |
| FR-5.4 | Record "used sources" for traceability |

---

## Data Model Changes

```sql
CREATE TABLE public.kb_documents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID REFERENCES public.workspaces(id),
  user_id UUID REFERENCES public.users(id),
  namespace TEXT NOT NULL DEFAULT 'personal',  -- 'workspace' | 'personal'
  source_type TEXT NOT NULL,  -- 'drive' | 'upload' | 'generated'
  source_ref TEXT,  -- drive file ID, upload path, or artifact ID
  source_url TEXT,
  title TEXT,
  file_type TEXT,
  file_size INTEGER,
  content_hash TEXT,  -- for dedup
  extracted_text TEXT,
  summary TEXT,
  metadata JSONB DEFAULT '{}',
  embedding_status TEXT DEFAULT 'pending',  -- pending, processing, completed, failed
  last_indexed_at TIMESTAMPTZ,
  etag TEXT,  -- for Drive sync
  is_deleted BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE public.kb_chunks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  document_id UUID REFERENCES public.kb_documents(id) ON DELETE CASCADE,
  chunk_index INTEGER,
  content TEXT,
  embedding vector(1536),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE public.kb_drive_connections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID REFERENCES public.workspaces(id),
  user_id UUID REFERENCES public.users(id),
  scope TEXT NOT NULL,  -- 'workspace' | 'personal'
  folder_ids TEXT[],
  sync_status TEXT DEFAULT 'pending',
  last_sync_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## API Contracts

### POST /api/kb/drive/connect
Connect Drive and select folders.

### POST /api/kb/drive/sync
Trigger manual sync.

### GET /api/kb/documents
List KB documents with filters.

### GET /api/kb/search
Semantic search across KB.

### POST /api/kb/documents
Add document to KB (for uploads).

---

## Test Plan

- Permission tests (workspace vs personal isolation)
- Ingestion job tests (various file types)
- Sync/index tests (incremental, deletion)
- E2E: connect drive â†’ index â†’ chat query
- E2E: upload â†’ KB â†’ chat query
- E2E: generate QBR â†’ KB appears â†’ retrievable

---

## Definition of Done

- [ ] Drive connection working
- [ ] Folder selection and initial sync working
- [ ] Chat uploads appear in KB
- [ ] Generated artifacts appear in KB
- [ ] KB UI with tabs, filters, search
- [ ] Chat retrieval with citations
- [ ] Permission isolation enforced
- [ ] All tests passing
- [ ] Deployed to staging/production
