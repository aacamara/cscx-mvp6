# PRD-188: Google Calendar Sync

## Overview
| Field | Value |
|-------|-------|
| **PRD ID** | PRD-188 |
| **Title** | Google Calendar Sync |
| **Category** | G: CRM & Tool Integrations |
| **Priority** | P0 |
| **Status** | Not Started |
| **Created** | 2026-01-29 |
| **Last Updated** | 2026-01-29 |

## Problem Statement
CSMs schedule numerous customer meetings but this valuable engagement data doesn't flow into CSCX.AI for health tracking and context. Meeting frequency, no-shows, and scheduling patterns are important signals that currently require manual logging. Additionally, CSMs cannot schedule meetings directly from the customer context within CSCX.AI.

## User Stories

### Primary User Stories
1. **As a CSM**, I want to schedule customer meetings directly from CSCX.AI so that meetings are automatically linked to the right account.
2. **As a CSM**, I want past meeting history visible in customer context so that I can see engagement patterns at a glance.
3. **As CSCX.AI**, I want to calculate meeting engagement metrics to include in customer health scores.

### Secondary User Stories
4. **As a CSM**, I want meeting prep briefs generated before upcoming customer calls.
5. **As a CS Leader**, I want visibility into CSM-customer meeting frequency across the portfolio.

## Functional Requirements

### FR-1: Google OAuth Integration
- Support Google OAuth 2.0 for Calendar access
- Request scopes:
  - `https://www.googleapis.com/auth/calendar`
  - `https://www.googleapis.com/auth/calendar.events`
- Token storage and automatic refresh
- Support for multiple Google accounts

### FR-2: Calendar Event Sync
- Bi-directional event sync:
  - CSCX.AI → Google Calendar (create meetings)
  - Google Calendar → CSCX.AI (read meetings)
- Sync event data:
  - Title, description
  - Start/end time
  - Attendees
  - Location/video link
  - Status (confirmed, tentative, cancelled)

### FR-3: Customer Meeting Detection
- Auto-detect customer meetings via:
  - Attendee email domain matching
  - Calendar event title patterns
  - Manual tagging
- Link detected meetings to customer records
- Handle multiple customers in one meeting

### FR-4: Meeting Creation from CSCX.AI
- Create events directly from customer view
- Pre-populate:
  - Customer stakeholder attendees
  - CSM availability
  - Meeting type template (QBR, Check-in, etc.)
- Send calendar invites automatically
- Requires approval per HITL policy

### FR-5: Availability Check
- Query CSM availability for scheduling
- Suggest optimal meeting times
- Check stakeholder availability (if shared calendar)
- Handle timezone conversions

### FR-6: Meeting Metrics
- Calculate engagement metrics:
  - Meetings per month
  - Last meeting date
  - No-show rate
  - Meeting duration trends
- Include in health score calculation

### FR-7: Meeting Prep Automation
- Generate pre-meeting briefs before scheduled calls
- Include:
  - Customer health summary
  - Recent activity
  - Open action items
  - Suggested talking points
- Deliver via Slack/email before meeting

## Non-Functional Requirements

### NFR-1: Performance
- Event creation < 3 seconds
- Availability check < 2 seconds
- Sync latency < 5 minutes

### NFR-2: Reliability
- 99.9% sync accuracy
- Handle Google Calendar outages gracefully
- Retry failed syncs

## Technical Implementation

### API Endpoints
```
POST   /api/google/calendar/connect
GET    /api/google/calendar/events
POST   /api/google/calendar/events
PUT    /api/google/calendar/events/:id
DELETE /api/google/calendar/events/:id
GET    /api/google/calendar/availability
GET    /api/google/calendar/customer/:customerId
```

### Google Calendar API Usage
```javascript
// List events
GET https://www.googleapis.com/calendar/v3/calendars/primary/events
?timeMin=2026-01-01T00:00:00Z
&timeMax=2026-01-31T23:59:59Z
&singleEvents=true

// Create event
POST https://www.googleapis.com/calendar/v3/calendars/primary/events
{
  "summary": "QBR - Acme Corp",
  "description": "Quarterly Business Review\nGenerated by CSCX.AI",
  "start": {"dateTime": "2026-02-15T10:00:00-08:00"},
  "end": {"dateTime": "2026-02-15T11:00:00-08:00"},
  "attendees": [
    {"email": "john@acmecorp.com"},
    {"email": "csm@company.com"}
  ],
  "conferenceData": {
    "createRequest": {"requestId": "unique-id"}
  }
}

// Check availability
POST https://www.googleapis.com/calendar/v3/freeBusy
{
  "timeMin": "2026-02-01T00:00:00Z",
  "timeMax": "2026-02-07T23:59:59Z",
  "items": [{"id": "primary"}]
}
```

### Database Schema
Uses existing `meetings` table plus:
```sql
CREATE TABLE calendar_sync_mapping (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  meeting_id UUID REFERENCES meetings(id),
  google_event_id TEXT UNIQUE,
  user_id TEXT,
  last_synced_at TIMESTAMPTZ,
  sync_direction VARCHAR(10)
);

CREATE TABLE meeting_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id),
  metric_month DATE,
  meeting_count INTEGER,
  total_duration_minutes INTEGER,
  no_shows INTEGER,
  avg_attendees NUMERIC,
  UNIQUE(customer_id, metric_month)
);
```

## User Interface

### Customer Meeting Panel
- Upcoming meetings list
- Past meetings history
- "Schedule Meeting" button
- Meeting frequency indicator

### Meeting Creation Modal
- Select meeting type
- Choose stakeholder attendees
- Pick date/time with availability view
- Add agenda/description
- Confirm and send invites

### Calendar Widget
- Mini calendar view
- Customer meetings highlighted
- Quick navigation to details

## Acceptance Criteria

### AC-1: Authentication
- [ ] Google OAuth flow completes
- [ ] Tokens refresh automatically
- [ ] Multiple calendar support works

### AC-2: Sync
- [ ] Events sync bi-directionally
- [ ] Customer meetings auto-detected
- [ ] Sync status visible in UI

### AC-3: Meeting Creation
- [ ] Can create meeting from customer view
- [ ] Attendees receive invites
- [ ] Event appears in Google Calendar

### AC-4: Metrics
- [ ] Meeting frequency calculated
- [ ] Metrics included in health score
- [ ] Dashboard shows meeting trends

## Chat UI Integration

### Natural Language Commands
| Command | Action |
|---------|--------|
| "Schedule a meeting with [account]" | Open meeting creator |
| "When is my next meeting with [account]?" | Show upcoming |
| "How often do I meet with [account]?" | Show frequency |
| "Check my availability this week" | Show free slots |

### Quick Actions
- Schedule kickoff meeting
- Book QBR
- Find next available slot

## Success Metrics
| Metric | Target |
|--------|--------|
| Meeting sync accuracy | > 99% |
| Auto-detection accuracy | > 90% |
| CSM meeting logging time saved | 80% |

## Related PRDs
- PRD-189: Outlook Calendar Integration
- PRD-120: QBR Scheduling → Auto-Prep
- PRD-127: Meeting Booked → Pre-Meeting Research
